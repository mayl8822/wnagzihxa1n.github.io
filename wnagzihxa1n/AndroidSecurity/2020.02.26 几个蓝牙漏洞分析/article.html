
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-solarized-light .ace_gutter {background: #fbf1d3;color: #333}.ace-solarized-light .ace_print-margin {width: 1px;background: #e8e8e8}.ace-solarized-light {background-color: #FDF6E3;color: #586E75}.ace-solarized-light .ace_cursor {color: #000000}.ace-solarized-light .ace_marker-layer .ace_selection {background: rgba(7, 54, 67, 0.09)}.ace-solarized-light.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #FDF6E3;}.ace-solarized-light .ace_marker-layer .ace_step {background: rgb(255, 255, 0)}.ace-solarized-light .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgba(147, 161, 161, 0.50)}.ace-solarized-light .ace_marker-layer .ace_active-line {background: #EEE8D5}.ace-solarized-light .ace_gutter-active-line {background-color : #EDE5C1}.ace-solarized-light .ace_marker-layer .ace_selected-word {border: 1px solid #073642}.ace-solarized-light .ace_invisible {color: rgba(147, 161, 161, 0.50)}.ace-solarized-light .ace_keyword,.ace-solarized-light .ace_meta,.ace-solarized-light .ace_support.ace_class,.ace-solarized-light .ace_support.ace_type {color: #859900}.ace-solarized-light .ace_constant.ace_character,.ace-solarized-light .ace_constant.ace_other {color: #CB4B16}.ace-solarized-light .ace_constant.ace_language {color: #B58900}.ace-solarized-light .ace_constant.ace_numeric {color: #D33682}.ace-solarized-light .ace_fold {background-color: #268BD2;border-color: #586E75}.ace-solarized-light .ace_entity.ace_name.ace_function,.ace-solarized-light .ace_entity.ace_name.ace_tag,.ace-solarized-light .ace_support.ace_function,.ace-solarized-light .ace_variable,.ace-solarized-light .ace_variable.ace_language {color: #268BD2}.ace-solarized-light .ace_storage {color: #073642}.ace-solarized-light .ace_string {color: #2AA198}.ace-solarized-light .ace_string.ace_regexp {color: #D30102}.ace-solarized-light .ace_comment,.ace-solarized-light .ace_entity.ace_other.ace_attribute-name {color: #93A1A1}.ace-solarized-light .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWNgYGBgYHjy8NJ/AAjgA5fzQUmBAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>2020.02.26 几个蓝牙漏洞分析</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><p>最近分析了一些蓝牙漏洞，发现挺有趣的，蓝牙漏洞真的多啊，安卓上的蓝牙叫作BlueDroid</p>
<p>蓝牙有专门一份文档讲解细节，比如各类协议的细节，不同的协议该如何构建包，处理包，我读的是Core_v5.1，也叫作核心，在看大佬公开的POC的时候，我碰到不懂的宏都会去核心搜一下，一般都会有，注释写的非常详细，对照着核心去读源码，还是不错的，一开始会觉得协议很绕，但是多看核心，多理解代码的常见写法，比如如何获取用户传入的数据指针<code>p</code>，如何取不同字节长度的数据，慢慢的就不会纠结看不懂协议了</p>
<p>网络上有一些蓝牙的分析资料，比如360 Alpha Lab的JiounDai，大佬前两年研究的蓝牙，公开了一系列的POC，我就是跟着大佬的POC去搜谷歌安全公告，然后对照着补丁去反推漏洞，谢谢大佬，想起我毕业那会还是大佬面试的我</p>
<p>这里我分享一些我最近分析的漏洞</p>
<p>这是蓝牙协议栈，我们不关注下面的<code>Bluetooth Radio</code>和<code>Bluetooth Baseband</code>，只关心<code>L2CAP</code>和<code>BNEP</code>这两层，不要纠结在数据如何构建发送到底层，如何一层层传入啥的，我们只需要知道如何使用代码进行对应的连接，然后知道每一层的数据是如何发送与接收即可</p>
<p><img src="resources/4B0401135B3B24CDEF0875D21F12F7BB.jpg" alt="IMAGE" width="831" height="547"></p>
<h2>CVE-2018-9359</h2>
<p>process_l2cap_cmd L2CAP_CMD_INFO_REQ未判断缓冲区边界造成信息泄露</p>
<p>补丁修改的地方比较多，通过描述可以看到是在<code>process_l2cap_cmd()</code>里的一个越界读漏洞，补的都是同样的代码，说明这块代码缺少检查，这里只截取部分补丁代码</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>DO NOT MERGE Fix OOB read in process_l2cap_cmd
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74202041
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74196706
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74201143
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Test: manual
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Change-Id: Ic25f7f3777d0375f76cc91e4d129b1636f1c388d
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>(cherry picked from commit ff15adf5150527db1012b9f7777066522835e2db)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>diff --git a/stack/l2cap/l2c_main.cc b/stack/l2cap/l2c_main.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>index 83d1737..7c1ef48 100644
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>--- a/stack/l2cap/l2c_main.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+++ b/stack/l2cap/l2c_main.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -320,8 +320,16 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> switch (cmd_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>   case L2CAP_CMD_REJECT:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        if (p + 2 &gt; p_next_cmd) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          android_errorWriteLog(0x534e4554, "74202041");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> STREAM_TO_UINT16(rej_reason, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> if (rej_reason == L2CAP_CMD_REJ_MTU_EXCEEDED) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          if (p + 2 &gt; p_next_cmd) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+            android_errorWriteLog(0x534e4554, "74202041");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+            return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   STREAM_TO_UINT16(rej_mtu, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   /* What to do with the MTU reject ? We have negotiated an MTU. For now
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -332,6 +340,10 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   p_lcb-&gt;handle, rej_mtu);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> if (rej_reason == L2CAP_CMD_REJ_INVALID_CID) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          if (p + 4 &gt; p_next_cmd) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+            android_errorWriteLog(0x534e4554, "74202041");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+            return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   STREAM_TO_UINT16(rcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>   STREAM_TO_UINT16(lcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ...
</div></div></div></pre>
<p>我们挑第一个补丁点来分析，对<code>p + 2</code>进行计算判断</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>switch (cmd_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>   case L2CAP_CMD_REJECT:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        if (p + 2 &gt; p_next_cmd) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          android_errorWriteLog(0x534e4554, "74202041");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        }
</div></div></div></pre>
<p>找到代码对应的函数<code>process_l2cap_cmd()</code>，代码比较长，但是我们只需要关注关键的地方就行了，比如变量<code>p</code>的赋值，<code>p</code>来自上层函数</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Function         process_l2cap_cmd
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Description      This function is called when a packet is received on the
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  L2CAP signalling CID
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void process_l2cap_cmd(tL2C_LCB* p_lcb, uint8_t* p, uint16_t pkt_len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    switch (cmd_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  case L2CAP_CMD_REJECT:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(rej_reason, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (rej_reason == L2CAP_CMD_REJ_MTU_EXCEEDED) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>  STREAM_TO_UINT16(rej_mtu, p);
</div></div></div></pre>
<p>当接收到<code>ACL</code>数据包，HCI接口就会调用<code>l2c_rcv_acl_data()</code>来处理，再往上就不需要跟了，因为这里已经取出了<code>p</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Function         l2c_rcv_acl_data
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Description      This function is called from the HCI Interface when an ACL
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  data packet is received.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void l2c_rcv_acl_data(BT_HDR* p_msg) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  uint8_t* p = (uint8_t*)(p_msg + 1) + p_msg-&gt;offset;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  STREAM_TO_UINT16(handle, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  /* Send the data through the channel state machine */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  if (rcv_cid == L2CAP_SIGNALLING_CID) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    process_l2cap_cmd(p_lcb, p, l2cap_len); // &lt;--
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    osi_free(p_msg);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }
</div></div></div></pre>
<p>补充一下<code>STREAM_TO_UINT8()</code>的实现如下，其它函数同理，<code>p</code>会往后移动</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define STREAM_TO_UINT8(u8, p) \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  {                            \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (u8) = (uint8_t)(*(p));    \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (p) += 1;                  \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }
</div></div></div></pre>
<p>所以再回到<code>process_l2cap_cmd()</code>，仔细读一下代码，看所有的漏洞点，其实就是取了4字节长度的信令长度之后，又在<code>switch/case</code>里进行了取值，而此时未进行判断取值的位置是否超出缓冲区范围</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void process_l2cap_cmd(tL2C_LCB* p_lcb, uint8_t* p, uint16_t pkt_len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">是</span>BT_TRANSPORT_LE<span class="ace_cjk" style="width:NaNpx">模</span><span class="ace_cjk" style="width:NaNpx">式</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span>BT_TRANSPORT_BR_EDR
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* if l2cap command received in CID 1 on top of an LE link, ignore this command */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (p_lcb-&gt;transport == BT_TRANSPORT_LE) return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // #define L2CAP_DEFAULT_MTU (672)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* Reject the packet if it exceeds the default Signalling Channel MTU */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (pkt_len &gt; L2CAP_DEFAULT_MTU) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Core Spec requires a single response to the first command found in a
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    *multi-command
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ** L2cap packet.  If only responses in the packet, then it will be ignored.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ** Here we simply mark the bad packet and decide which cmd ID to reject
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    *later
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    pkt_size_rej = true;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_ERROR("L2CAP SIG MTU Pkt Len Exceeded (672) -&gt; pkt_len: %d", pkt_len);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">储</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">起</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span><span class="ace_cjk" style="width:NaNpx">与</span><span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">束</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p_next_cmd = p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p_pkt_end = p + pkt_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memset(&amp;cfg_info, 0, sizeof(cfg_info));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span>L2CAP<span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">多</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">令</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* An L2CAP packet may contain multiple commands */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    while (true) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">短</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">令</span><span class="ace_cjk" style="width:NaNpx">是</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Smallest command is 4 bytes */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    p = p_next_cmd; // p<span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">游</span><span class="ace_cjk" style="width:NaNpx">动</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (p &gt; (p_pkt_end - 4)) break; // <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">证</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">余</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">至</span><span class="ace_cjk" style="width:NaNpx">少</span><span class="ace_cjk" style="width:NaNpx">还</span><span class="ace_cjk" style="width:NaNpx">有</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">余</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">是</span>cmd_code
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">二</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">是</span>id
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">三</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">是</span>cmd_len
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT8(cmd_code, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT8(id, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(cmd_len, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // #define BT_SMALL_BUFFER_SIZE 660
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (cmd_len &gt; BT_SMALL_BUFFER_SIZE) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_WARNING("L2CAP - Invalid MTU Size");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    l2cu_send_peer_cmd_reject(p_lcb, L2CAP_CMD_REJ_MTU_EXCEEDED, id, 0, 0);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">检</span><span class="ace_cjk" style="width:NaNpx">查</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">上</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">令</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">超</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">小</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Check command length does not exceed packet length */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    p_next_cmd = p + cmd_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (p_next_cmd &gt; p_pkt_end) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_WARNING("Command len bad  pkt_len: %d  cmd_len: %d  code: %d", pkt_len, cmd_len, cmd_code);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_DEBUG("cmd_code: %d, id:%d, cmd_len:%d", cmd_code, id, cmd_len);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">太</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">考</span><span class="ace_cjk" style="width:NaNpx">虑</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">丢</span><span class="ace_cjk" style="width:NaNpx">掉</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Bad L2CAP packet length, look or cmd to reject */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (pkt_size_rej) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* If command found rejected it and we're done, otherwise keep looking */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (l2c_is_cmd_rejected(cmd_code, id, p_lcb))
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    else
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    continue; /* Look for next cmd/response in current packet */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">准</span><span class="ace_cjk" style="width:NaNpx">备</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">漏</span><span class="ace_cjk" style="width:NaNpx">洞</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">域</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    switch (cmd_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case L2CAP_CMD_REJECT:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span>2<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">：</span>p + 2 &gt; p_pkt_end
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(rej_reason, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (rej_reason == L2CAP_CMD_REJ_MTU_EXCEEDED) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span>2<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">：</span>p + 2 &gt; p_pkt_end
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(rej_mtu, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_WARNING("L2CAP - MTU rej Handle: %d MTU: %d", p_lcb-&gt;handle, rej_mtu);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (rej_reason == L2CAP_CMD_REJ_INVALID_CID) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">：</span>p + 4 &gt; p_pkt_end
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(rcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(lcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">漏</span><span class="ace_cjk" style="width:NaNpx">洞</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span><span class="ace_cjk" style="width:NaNpx">泄</span><span class="ace_cjk" style="width:NaNpx">露</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">泄</span><span class="ace_cjk" style="width:NaNpx">露</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">就</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">往</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">刚</span><span class="ace_cjk" style="width:NaNpx">好</span>L2CAP_CMD_INFO_REQ<span class="ace_cjk" style="width:NaNpx">满</span><span class="ace_cjk" style="width:NaNpx">足</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span>2<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span>l2cu_send_peer_info_rsp()<span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">送</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">去</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case L2CAP_CMD_INFO_REQ:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">：</span>p + 2 &gt; p_pkt_end
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(info_type, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    l2cu_send_peer_info_rsp(p_lcb, id, info_type);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    default:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_WARNING("L2CAP - bad cmd code: %d", cmd_code);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    l2cu_send_peer_cmd_reject(p_lcb, L2CAP_CMD_REJ_NOT_UNDERSTOOD, id, 0, 0);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<h2>CVE-2018-9360</h2>
<p>process_l2cap_cmd L2CAP_CMD_CONN_REQ未判断缓冲区边界造成信息泄露</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void process_l2cap_cmd(tL2C_LCB* p_lcb, uint8_t* p, uint16_t pkt_len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* An L2CAP packet may contain multiple commands */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    while (true) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Smallest command is 4 bytes */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    p = p_next_cmd; // p<span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">游</span><span class="ace_cjk" style="width:NaNpx">动</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (p &gt; (p_pkt_end - 4)) break; // <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">证</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">余</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">至</span><span class="ace_cjk" style="width:NaNpx">少</span><span class="ace_cjk" style="width:NaNpx">还</span><span class="ace_cjk" style="width:NaNpx">有</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">余</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    switch (cmd_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case L2CAP_CMD_CONN_REQ:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">：</span>p + 2 &gt; p_pkt_end
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(con_info.psm, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(rcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_rcb = l2cu_find_rcb_by_psm(con_info.psm);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (p_rcb == NULL) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_WARNING("L2CAP - rcvd conn req for unknown PSM: %d", con_info.psm);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    l2cu_reject_connection(p_lcb, rcid, id, L2CAP_CONN_NO_PSM);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    } 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>当<code>l2cu_find_rcb_by_psm(con_info.psm)</code>找不到的时候，就会返回<code>NULL</code>，会调用<code>l2cu_reject_connection()</code>，这个函数描述可以仔细看看，不存在PSM的时候就会调用，并且通过<code>l2c_link_check_send_pkts()</code>发送数据包回去</p>
<h2>CVE-2018-9361</h2>
<p>process_l2cap_cmd L2CAP_CMD_DISC_REQ未判断缓冲区边界造成信息泄露</p>
<p>当我们找不到CCB的时候，就会调用<code>l2cu_send_peer_disc_rsp()</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void process_l2cap_cmd(tL2C_LCB* p_lcb, uint8_t* p, uint16_t pkt_len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* An L2CAP packet may contain multiple commands */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    while (true) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Smallest command is 4 bytes */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    p = p_next_cmd; // p<span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">游</span><span class="ace_cjk" style="width:NaNpx">动</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (p &gt; (p_pkt_end - 4)) break; // <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">证</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">余</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">至</span><span class="ace_cjk" style="width:NaNpx">少</span><span class="ace_cjk" style="width:NaNpx">还</span><span class="ace_cjk" style="width:NaNpx">有</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">余</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    switch (cmd_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case L2CAP_CMD_DISC_REQ:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">了</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">：</span>p + 2 &gt; p_pkt_end
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(lcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_UINT16(rcid, p);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_ccb = l2cu_find_ccb_by_cid(p_lcb, lcid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (p_ccb != NULL) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (p_ccb-&gt;remote_cid == rcid) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_ccb-&gt;remote_id = id;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    l2c_csm_execute(p_ccb, L2CEVT_L2CAP_DISCONNECT_REQ, &amp;con_info);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    } else
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    l2cu_send_peer_disc_rsp(p_lcb, id, lcid, rcid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>这个函数用来发送停止连接的包，发送回去的还有内存数据</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Function         l2cu_send_peer_disc_rsp
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Description      Build and send an L2CAP "disconnect response" message
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  to the peer.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  This function is passed the parameters for the disconnect
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  response instead of the CCB address, as it may be called
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  to send a disconnect response when there is no CCB.
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void l2cu_send_peer_disc_rsp(tL2C_LCB* p_lcb, uint8_t remote_id, uint16_t local_cid, uint16_t remote_cid) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    BT_HDR* p_buf;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t* p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">建</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">头</span><span class="ace_cjk" style="width:NaNpx">部</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p_buf = l2cu_build_header(p_lcb, L2CAP_DISC_RSP_LEN, L2CAP_CMD_DISC_RSP, remote_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (p_buf == NULL) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    L2CAP_TRACE_WARNING("L2CAP - no buffer for disc_rsp");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // p<span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p = (uint8_t*)(p_buf + 1) + L2CAP_SEND_CMD_OFFSET + HCI_DATA_PREAMBLE_SIZE + L2CAP_PKT_OVERHEAD + L2CAP_CMD_OVERHEAD;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">读</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">的</span>4<span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">送</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">去</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    UINT16_TO_STREAM(p, local_cid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    UINT16_TO_STREAM(p, remote_cid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    l2c_link_check_send_pkts(p_lcb, NULL, p_buf);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>这三个漏洞说来也有趣，它们在同一个补丁里修复</p>
<ul>
<li>
<ul>
<li><a href="https://android.googlesource.com/platform/system/bt/+/b66fc16410ff96e9119f8eb282e67960e79075c8">https://android.googlesource.com/platform/system/bt/+/b66fc16410ff96e9119f8eb282e67960e79075c8</a></li>
</ul>
</li>
</ul>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>DO NOT MERGE Fix OOB read in process_l2cap_cmd
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74202041
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74196706
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74201143
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Test: manual
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Change-Id: Ic25f7f3777d0375f76cc91e4d129b1636f1c388d
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>(cherry picked from commit ff15adf5150527db1012b9f7777066522835e2db)
</div></div></div></pre>
<p>Quarkslab发现了这三个漏洞其中两个，真是皂滑弄人啊，这么明显的漏洞大佬们竟然漏了一个，而且就在同一个地方，以后审计的时候还是要仔细些，说不定就捡漏了呢</p>
<p><img src="resources/80E29E8FAECFBDD05F093B8368A53E7F.jpg" alt="IMAGE" width="594" height="111"></p>
<p>我们看到，这里还有一个漏洞：<code>smp_sm_event() OOB Array indexing</code></p>
<h2>CVE-2018-9365</h2>
<p><code>smp_sm_event</code>数组越界访问导致RCE</p>
<p>补丁</p>
<ul>
<li><a href="https://android.googlesource.com/platform/system/bt/+/ae94a4c333417a1829030c4d87a58ab7f1401308">https://android.googlesource.com/platform/system/bt/+/ae94a4c333417a1829030c4d87a58ab7f1401308</a></li>
</ul>
<p>补丁描述修复了在<code>smp_sm_event()</code>里的非预期，判断了<code>p_cb-&gt;role</code>大于等于2则报错返回，我们猜测这里可能是字段<code>p_cb-&gt;role</code>可以由连接者控制</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>DO NOT MERGE Fix unexpected behavior in smp_sm_event
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 74121126
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Test: manual
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Change-Id: Ie5dd841d6461ad057c4ab572007f38c5446aba53
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>(cherry picked from commit 652798b2f2d6c90e0fc95c00ccfb91e2870b03d4)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>diff --git a/stack/smp/smp_main.cc b/stack/smp/smp_main.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>index 829a5d4..49e2ece 100644
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>--- a/stack/smp/smp_main.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+++ b/stack/smp/smp_main.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -18,6 +18,7 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include "bt_target.h"
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+#include &lt;cutils/log.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include &lt;string.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include "smp_int.h"
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -954,6 +955,13 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   uint8_t curr_state = p_cb-&gt;state;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   tSMP_SM_TBL state_table;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   uint8_t action, entry, i;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+  if (p_cb-&gt;role &gt;= 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    SMP_TRACE_DEBUG("Invalid role: %d", 1. );
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    android_errorWriteLog(0x534e4554, "74121126");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+  }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   tSMP_ENTRY_TBL entry_table = smp_entry_table[p_cb-&gt;role];
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   SMP_TRACE_EVENT("main smp_sm_event");
</div></div></div></pre>
<p>我们从头开始分析，当SMP Channel有来自L2CAP的数据时，会调用<code>smp_data_received()</code>进行数据的处理，这里我们的关注点在于<code>cmd</code>为<code>SMP_OPCODE_PAIRING_REQ 0x01</code>时的情况，当传入的是<code>SMP_OPCODE_PAIRING_REQ</code>，会调用<code>L2CA_GetBleConnRole()</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void smp_data_received(uint16_t channel, const RawAddress&amp; bd_addr,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>  BT_HDR* p_buf) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  tSMP_CB* p_cb = &amp;smp_cb;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  uint8_t* p = (uint8_t*)(p_buf + 1) + p_buf-&gt;offset;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  uint8_t cmd;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  SMP_TRACE_EVENT("SMDBG l2c %s", __func__);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  STREAM_TO_UINT8(cmd, p); // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  /* sanity check */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  if ((SMP_OPCODE_MAX &lt; cmd) || (SMP_OPCODE_MIN &gt; cmd)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    SMP_TRACE_WARNING("Ignore received command with RESERVED code 0x%02x", cmd);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    osi_free(p_buf);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  // #define SMP_OPCODE_PAIRING_REQ 0x01
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  // <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">是</span>0x01<span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span>if<span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">支</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  /* reject the pairing request if there is an on-going SMP pairing */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  if (SMP_OPCODE_PAIRING_REQ == cmd || SMP_OPCODE_SEC_REQ == cmd) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if ((p_cb-&gt;state == SMP_STATE_IDLE) &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    (p_cb-&gt;br_state == SMP_BR_STATE_IDLE) &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    !(p_cb-&gt;flags &amp; SMP_PAIR_FLAGS_WE_STARTED_DD)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  p_cb-&gt;role = L2CA_GetBleConnRole(bd_addr); //<span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">行</span>p_cb-&gt;role<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">赋</span><span class="ace_cjk" style="width:NaNpx">值</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  p_cb-&gt;pairing_bda = bd_addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    } else if (bd_addr != p_cb-&gt;pairing_bda) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  osi_free(p_buf);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  smp_reject_unexpected_pairing_command(bd_addr);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>其中第二个参数类型<code>RawAddress</code>的部分实现如下，可以看到其数据以及转换的方式</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static_assert(sizeof(RawAddress) == 6, "RawAddress must be 6 bytes long!");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>const RawAddress RawAddress::kAny{{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}};
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>const RawAddress RawAddress::kEmpty{{0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>RawAddress::RawAddress(const uint8_t (&amp;addr)[6]) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  std::copy(addr, addr + kLength, address);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>};
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>std::string RawAddress::ToString() const {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  return base::StringPrintf("%02x:%02x:%02x:%02x:%02x:%02x", address[0],
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    address[1], address[2], address[3], address[4],
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    address[5]);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p><code>L2CA_GetBleConnRole()</code>会先给<code>role</code>赋值为<code>HCI_ROLE_UNKNOWN</code>，这个值是<code>0xff</code>，之后进行遍历搜索，如果搜到了就将<code>role</code>赋值为<code>p_lcp-&gt;link_role</code>，如果没搜到就是初始化的值<code>0xff</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/* HCI role defenitions */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define HCI_ROLE_MASTER 0x00
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define HCI_ROLE_SLAVE 0x01
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define HCI_ROLE_UNKNOWN 0xff
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>uint8_t L2CA_GetBleConnRole(const RawAddress&amp; bd_addr) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  uint8_t role = HCI_ROLE_UNKNOWN;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  tL2C_LCB* p_lcb;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  p_lcb = l2cu_find_lcb_by_bd_addr(bd_addr, BT_TRANSPORT_LE);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  if (p_lcb != NULL) role = p_lcb-&gt;link_role;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  return role;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>回到<code>smp_data_received()</code>，会调用到<code>smp_sm_event()</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static void smp_data_received(uint16_t channel, const RawAddress&amp; bd_addr,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>  BT_HDR* p_buf) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  /* reject the pairing request if there is an on-going SMP pairing */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  if (SMP_OPCODE_PAIRING_REQ == cmd || SMP_OPCODE_SEC_REQ == cmd) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if ((p_cb-&gt;state == SMP_STATE_IDLE) &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    (p_cb-&gt;br_state == SMP_BR_STATE_IDLE) &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    !(p_cb-&gt;flags &amp; SMP_PAIR_FLAGS_WE_STARTED_DD)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  p_cb-&gt;role = L2CA_GetBleConnRole(bd_addr); // &lt;-- 1
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  p_cb-&gt;pairing_bda = bd_addr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    } 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  if (bd_addr == p_cb-&gt;pairing_bda) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p_cb-&gt;rcvd_cmd_code = cmd;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p_cb-&gt;rcvd_cmd_len = (uint8_t)p_buf-&gt;len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    smp_sm_event(p_cb, cmd, p); // &lt;-- 2
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  osi_free(p_buf);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>通过查看该函数，我们可以注意到，后续会直接使用该字段作为下标对数组进行取值操作</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void smp_sm_event(tSMP_CB* p_cb, tSMP_EVENT event, void* p_data) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  uint8_t curr_state = p_cb-&gt;state;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  tSMP_SM_TBL state_table;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  uint8_t action, entry, i;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  tSMP_ENTRY_TBL entry_table = smp_entry_table[p_cb-&gt;role];
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  ...
</div></div></div></pre>
<p>我们通过源码找到<code>smp_entry_table</code>的定义，这个数组的长度只有2，结合前面的分析，<code>smp_entry_table[p_cb-&gt;role]</code>的取值可能是<code>smp_entry_table[0x00]</code>，<code>smp_entry_table[0x01]</code>和<code>smp_entry_table[0xff]</code>，所以这里就出现了一个越界访问的漏洞</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static const tSMP_ENTRY_TBL smp_entry_table[] = {smp_master_entry_map, smp_slave_entry_map};
</div></div></div></pre>
<p>谷歌给这个漏洞的评级是Critical RCE，所以它是可以进行利用的，关于利用的姿势有待我找大佬学习一下</p>
<table>
<thead>
<tr>
<th>CVE</th>
<th>参考编号</th>
<th>类型</th>
<th>严重程度</th>
<th>已更新的 AOSP 版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE-2018-9365</td>
<td>A-74121126</td>
<td>RCE</td>
<td>Critical</td>
<td>6.0、6.0.1、7.0、7.1.1、7.1.2、8.0、8.1</td>
</tr>
</tbody>
</table>
<h2>CVE-2018-9357</h2>
<p>BNEP_Write越界写导致RCE</p>
<p>补丁</p>
<ul>
<li><a href="https://android.googlesource.com/platform/system/bt/+/9164ee1aaf3609b4771d39302e3af649f44c9e66">https://android.googlesource.com/platform/system/bt/+/9164ee1aaf3609b4771d39302e3af649f44c9e66</a></li>
</ul>
<p>这个漏洞我本来想先自己分析出来，但是没有找到漏洞点</p>
<p>我们先来看漏洞函数，这个函数是用于在BNEP连接里传输数据，所以我们需要先进行BNEP连接，一次BNEP连接，在处理数据包的时候，如果传入的是包指定了协议<code>BNEP_802_1_P_PROTOCOL</code>，就会触发漏洞</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Function         BNEP_Write
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Description      This function sends data over a BNEP connection
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Parameters:      handle       - handle of the connection to write
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  p_dest_addr  - BD_ADDR/Ethernet addr of the destination
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  p_data       - pointer to data start
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  protocol     - protocol type of the packet
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  p_src_addr   - (optional) BD_ADDR/ethernet address of the
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                                 source
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                                 (should be NULL if it is local BD Addr)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  fw_ext_present - forwarded extensions present
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> * Returns:         BNEP_WRONG_HANDLE       - if passed handle is not valid
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  BNEP_MTU_EXCEDED        - If the data length is greater than
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                                            the MTU
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  BNEP_IGNORE_CMD         - If the packet is filtered out
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  BNEP_Q_SIZE_EXCEEDED    - If the Tx Q is full
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  BNEP_NO_RESOURCES       - If not able to allocate a buffer
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *                  BNEP_SUCCESS            - If written successfully
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>tBNEP_RESULT BNEP_Write(uint16_t handle, const RawAddress&amp; p_dest_addr,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    uint8_t* p_data, uint16_t len, uint16_t protocol,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    const RawAddress* p_src_addr, bool fw_ext_present) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tBNEP_CONN* p_bcb;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t* p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // MTU<span class="ace_cjk" style="width:NaNpx">检</span><span class="ace_cjk" style="width:NaNpx">查</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* Check MTU size. Consider the possibility of having extension headers */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (len &gt; BNEP_MTU_SIZE) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    BNEP_TRACE_ERROR("BNEP_Write() length %d exceeded MTU %d", len, BNEP_MTU_SIZE);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return (BNEP_MTU_EXCEDED);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // handle<span class="ace_cjk" style="width:NaNpx">检</span><span class="ace_cjk" style="width:NaNpx">查</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if ((!handle) || (handle &gt; BNEP_MAX_CONNECTIONS)) return (BNEP_WRONG_HANDLE);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p_bcb = &amp;(bnep_cb.bcb[handle - 1]); // <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>p_pcb
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* Check if the packet should be filtered out */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (bnep_is_packet_allowed(p_bcb, p_dest_addr, protocol, fw_ext_present, p_data) != BNEP_SUCCESS) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /*
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ** If packet is filtered and ext headers are present
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ** drop the data and forward the ext headers
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (fw_ext_present) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    uint8_t ext, length;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    uint16_t org_len, new_len;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* parse the extension headers and findout the new packet len */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    org_len = len; // org_len<span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span>Buffer<span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new_len = 0;   // new_len<span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">的</span>Buffer<span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p = p_data;    // p<span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span>Buffer<span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">起</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    do {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ext = *p_data++;    // <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">为</span>ext
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    length = *p_data++; // <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">二</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">为</span>length
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_data += length;   // <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">动</span>p_data<span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">扩</span><span class="ace_cjk" style="width:NaNpx">展</span><span class="ace_cjk" style="width:NaNpx">起</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new_len += (length + 2); // new_length<span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">上</span>ext<span class="ace_cjk" style="width:NaNpx">，</span>length<span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">上</span>length<span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (new_len &gt; org_len) return BNEP_IGNORE_CMD; // new_len<span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">超</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">始</span>Buffer<span class="ace_cjk" style="width:NaNpx">整</span><span class="ace_cjk" style="width:NaNpx">体</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span>org_len
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    } while (ext &amp; 0x80);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (protocol != BNEP_802_1_P_PROTOCOL)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    protocol = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    else {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // new_len<span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">上</span>4
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    new_len += 4;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_data[2] = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_data[3] = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    len = new_len; // len<span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">终</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">新</span>Buffer<span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_data = p; // p_data<span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span>Buffer<span class="ace_cjk" style="width:NaNpx">起</span><span class="ace_cjk" style="width:NaNpx">始</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    } else
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return BNEP_IGNORE_CMD;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>通过阅读POC，如下构造数据包，传入<code>BNEP()</code>的<code>p_data</code>就是<code>ext_1</code>开始往后的数据</p>
<p>我解释一下：</p>
<ol>
<li>第一轮循环：<code>ext</code>为<code>0x81</code>，表示还有一个<code>ext</code>，<code>length</code>为<code>0x00</code>，这样一轮循环后，<code>p_data</code>就指向了<code>ext_2</code>，<code>new_len</code>为2</li>
<li>第二轮循环：<code>ext</code>为<code>0x00</code>，表示后面没有<code>ext</code>了，<code>length</code>为<code>0x00</code>，第二轮循环结束后，<code>p_data</code>指向<code>OOB</code></li>
</ol>
<p>出了循环，指定<code>protocol</code>为<code>0x8100</code>也就是<code>BNEP_802_1_P_PROTOCOL</code>，就可以进入<code>else</code>分支，<code>new_len</code>加上4我没有理解在计算什么，后面直接对<code>p_data[2]</code>和<code>p_data[3]</code>进行赋值操作，此时完全没有判断<code>OOB[0]</code>开始往后4个字节属于Buffer边界内，这就是一个越界写漏洞</p>
<table>
<thead>
<tr>
<th>ext(1)</th>
<th>dst_addr(6)</th>
<th>src_addr(6)</th>
<th>Protocol(2)</th>
<th>ext_1(1)</th>
<th>Len_1(1)</th>
<th>ext_2(1)</th>
<th>Len_2(1)</th>
<th>OOB[0]</th>
<th>OOB[1]</th>
<th>OOB[2]</th>
<th>OOB[3]</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x80</td>
<td></td>
<td></td>
<td>0x8100</td>
<td>0x81</td>
<td>0x00</td>
<td>0x00</td>
<td>0x00</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>构造关键数据包的步骤如下</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>static int send_trigger_req(int sock_fd, uint8_t *dst, uint8_t *src) 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>{
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t *buf, *p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    int ret = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p = buf = malloc(0x200);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memset(buf, 0, 0x200);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t type = 0x80; // for ext
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    *p++ = type;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t dst_addr[6], src_addr[6];
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    getbd(dst, dst_addr);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memcpy(p, dst_addr, 6); // dst_addr
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p += 6;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    getbd(src, src_addr);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memcpy(p, src_addr, 6); //src_add
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p += 6;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // #define BNEP_802_1_P_PROTOCOL 0x8100
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint16_t protocol = 0x8100;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    UINT16_TO_BE_STREAM(p, protocol);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // rem_len start 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t ext_type = 0x81;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    *p++ = ext_type;  // enter while loop, and break
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t len = 0x00;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    *p++ = len;    // new_len = 2
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t ext2 = 0x00;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    *p++ = ext2;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t *p_len2 = p; // <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span>p<span class="ace_cjk" style="width:NaNpx">和</span>p_len2<span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">是</span>Len_2
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p++; // p<span class="ace_cjk" style="width:NaNpx">加</span>1<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span>OOB[0]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t len2 = p - buf - 15 - 2 - 2; // <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">算</span><span class="ace_cjk" style="width:NaNpx">出</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">就</span><span class="ace_cjk" style="width:NaNpx">是</span>0<span class="ace_cjk" style="width:NaNpx">，</span>len2 = 0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    UINT8_TO_BE_STREAM(p_len2, len2);    // <span class="ace_cjk" style="width:NaNpx">将</span>0<span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">到</span>Len2_2<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">置</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    send(sock_fd, buf, p - buf, 0);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    free(buf);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>每一个漏洞更具体的分析等到假期结束再跟大家见面吧</p>
</div></div>
      <script></script>
    </body>
    </html>
  