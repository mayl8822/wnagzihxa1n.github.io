
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-solarized-light .ace_gutter {background: #fbf1d3;color: #333}.ace-solarized-light .ace_print-margin {width: 1px;background: #e8e8e8}.ace-solarized-light {background-color: #FDF6E3;color: #586E75}.ace-solarized-light .ace_cursor {color: #000000}.ace-solarized-light .ace_marker-layer .ace_selection {background: rgba(7, 54, 67, 0.09)}.ace-solarized-light.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #FDF6E3;}.ace-solarized-light .ace_marker-layer .ace_step {background: rgb(255, 255, 0)}.ace-solarized-light .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgba(147, 161, 161, 0.50)}.ace-solarized-light .ace_marker-layer .ace_active-line {background: #EEE8D5}.ace-solarized-light .ace_gutter-active-line {background-color : #EDE5C1}.ace-solarized-light .ace_marker-layer .ace_selected-word {border: 1px solid #073642}.ace-solarized-light .ace_invisible {color: rgba(147, 161, 161, 0.50)}.ace-solarized-light .ace_keyword,.ace-solarized-light .ace_meta,.ace-solarized-light .ace_support.ace_class,.ace-solarized-light .ace_support.ace_type {color: #859900}.ace-solarized-light .ace_constant.ace_character,.ace-solarized-light .ace_constant.ace_other {color: #CB4B16}.ace-solarized-light .ace_constant.ace_language {color: #B58900}.ace-solarized-light .ace_constant.ace_numeric {color: #D33682}.ace-solarized-light .ace_fold {background-color: #268BD2;border-color: #586E75}.ace-solarized-light .ace_entity.ace_name.ace_function,.ace-solarized-light .ace_entity.ace_name.ace_tag,.ace-solarized-light .ace_support.ace_function,.ace-solarized-light .ace_variable,.ace-solarized-light .ace_variable.ace_language {color: #268BD2}.ace-solarized-light .ace_storage {color: #073642}.ace-solarized-light .ace_string {color: #2AA198}.ace-solarized-light .ace_string.ace_regexp {color: #D30102}.ace-solarized-light .ace_comment,.ace-solarized-light .ace_entity.ace_other.ace_attribute-name {color: #93A1A1}.ace-solarized-light .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWNgYGBgYHjy8NJ/AAjgA5fzQUmBAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>CVE-2018-9584 nfc_ncif_set_config_status 未检测长度越界读写</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><p>漏洞原理总结：NFC漏洞，在函数<code>nfc_ncif_set_config_status()</code>里直接将缓冲区数据作为长度进行拷贝操作，造成<code>uint8_t</code>类型溢出定义长度<code>125</code>位的数组</p>
<p>官方描述：In nfc_ncif_set_config_status of nfc_ncif.cc, there is a possible out of bounds write due to a missing bounds check. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.</p>
<p>官方描述翻译：函数<code>nfc_ncif.cc - nfc_ncif_set_config_status()</code>里，因为缺少边界检查，存在一个越界写，这可以造成提权并且无需额外的执行权限，利用这个漏洞也不需要用户交互</p>
<table>
<thead>
<tr>
<th>CVE</th>
<th>参考编号</th>
<th>类型</th>
<th>严重程度</th>
<th>已更新的 AOSP 版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE-2018-9584</td>
<td>A-114047681</td>
<td>EoP</td>
<td>高</td>
<td>7.0、7.1.1、7.1.2、8.0、8.1、9</td>
</tr>
</tbody>
</table>
<p>补丁</p>
<ul>
<li><a href="https://android.googlesource.com/platform/system/nfc/+/5f0f0cc6a10f710dea7e1ddd4ba19acb877a7081">https://android.googlesource.com/platform/system/nfc/+/5f0f0cc6a10f710dea7e1ddd4ba19acb877a7081</a></li>
</ul>
<p>看起来是很常规的未检测Buffer长度就进行读写数据的漏洞</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Prevent Out of bounds read/write in nfc_ncif_set_config_status
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Test: Nfc Enable/Disable; Android Beam; Tag reading
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 114047681
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Merged-In: Iaba48380879373a4807a9d50634f4f40be97ef81
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Change-Id: Iaba48380879373a4807a9d50634f4f40be97ef81
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>(cherry picked from commit 74cf5266c1bb9ee064cbc7e2544909d5d001e429)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>(cherry picked from commit f3b6b4e1502771d94418cd2bc02591eb4379db34)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>diff --git a/src/nfc/nfc/nfc_ncif.cc b/src/nfc/nfc/nfc_ncif.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>index 4fb767f..93666e0 100644
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>--- a/src/nfc/nfc/nfc_ncif.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+++ b/src/nfc/nfc/nfc_ncif.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -479,18 +479,33 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> ** Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> **
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> *******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-void nfc_ncif_set_config_status(uint8_t* p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-                                __attribute__((unused)) uint8_t len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+void nfc_ncif_set_config_status(uint8_t* p, uint8_t len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   tNFC_RESPONSE evt_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   if (nfc_cb.p_resp_cback) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-    evt_data.set_config.status = (tNFC_STATUS)*p++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-    evt_data.set_config.num_param_id = NFC_STATUS_OK;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-    if (evt_data.set_config.status != NFC_STATUS_OK) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-      evt_data.set_config.num_param_id = *p++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-      STREAM_TO_ARRAY(evt_data.set_config.param_ids, p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-                      evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    evt_data.set_config.num_param_id = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    if (len == 0) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      LOG(ERROR) &lt;&lt; StringPrintf("Insufficient RSP length");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      evt_data.set_config.status = NFC_STATUS_SYNTAX_ERROR;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      (*nfc_cb.p_resp_cback)(NFC_SET_CONFIG_REVT, &amp;evt_data);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    evt_data.set_config.status = (tNFC_STATUS)*p++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    if (evt_data.set_config.status != NFC_STATUS_OK &amp;&amp; len &gt; 1) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      evt_data.set_config.num_param_id = *p++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      if (evt_data.set_config.num_param_id &gt; NFC_MAX_NUM_IDS) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        android_errorWriteLog(0x534e4554, "114047681");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        LOG(ERROR) &lt;&lt; StringPrintf("OOB write num_param_id %d",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+                                   evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        evt_data.set_config.num_param_id = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      } else if (evt_data.set_config.num_param_id &lt;= len - 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        STREAM_TO_ARRAY(evt_data.set_config.param_ids, p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+                        evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      } else {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        LOG(ERROR) &lt;&lt; StringPrintf("Insufficient RSP length %d,num_param_id %d",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+                                   len, evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        evt_data.set_config.num_param_id = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+      }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span> (*nfc_cb.p_resp_cback)(NFC_SET_CONFIG_REVT, &amp;evt_data);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>   }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> }
</div></div></div></pre>
<p>从最开始走起，进入<code>p_msg-&gt;event</code>为<code>BT_EVT_TO_NFC_NCI</code>的分支，调用<code>nfc_ncif_process_event()</code>，</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nfc_task
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      NFC event processing task
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          nothing
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>uint32_t nfc_task(__attribute__((unused)) uint32_t arg) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint16_t event;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    NFC_HDR* p_msg;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    bool free_buf;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* Initialize the nfc control block */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    memset(&amp;nfc_cb, 0, sizeof(tNFC_CB));
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    DLOG_IF(INFO, nfc_debug_enabled) &lt;&lt; StringPrintf("NFC_TASK started.");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* main loop */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    while (true) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    event = GKI_wait(0xFFFF, 0);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (event == EVENT_MASK(GKI_SHUTDOWN_EVT)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    /* Handle NFC_TASK_EVT_TRANSPORT_READY from NFC HAL */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (event &amp; NFC_TASK_EVT_TRANSPORT_READY) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    DLOG_IF(INFO, nfc_debug_enabled)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    &lt;&lt; StringPrintf("NFC_TASK got NFC_TASK_EVT_TRANSPORT_READY.");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* Reset the NFC controller. */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nfc_set_state(NFC_STATE_CORE_INIT);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nci_snd_core_reset(NCI_RESET_TYPE_RESET_CFG);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (event &amp; NFC_MBOX_EVT_MASK) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* Process all incoming NCI messages */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    while ((p_msg = (NFC_HDR*)GKI_read_mbox(NFC_MBOX_ID)) != NULL) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    free_buf = true;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* Determine the input message type. */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    switch (p_msg-&gt;event &amp; NFC_EVT_MASK) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case BT_EVT_TO_NFC_NCI:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    free_buf = nfc_ncif_process_event(p_msg); // &lt;--
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (free_buf) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    GKI_freebuf(p_msg);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>通过对Buffer取第一字节并判断，进入<code>NCI_GID_CORE</code>分支，调用<code>nci_proc_core_rsp()</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MT_MASK 0xE0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MT_SHIFT 5
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_PBF_MASK 0x10
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_PBF_SHIFT 4
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_GID_MASK 0x0F
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/* parse byte0 of NCI packet */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MSG_PRS_HDR0(p, mt, pbf, gid)         \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    mt = (*(p)&amp;NCI_MT_MASK) &gt;&gt; NCI_MT_SHIFT;      \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (pbf) = (*(p)&amp;NCI_PBF_MASK) &gt;&gt; NCI_PBF_SHIFT; \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (gid) = *(p)++ &amp; NCI_GID_MASK;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nfc_ncif_process_event
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      This function is called to process the
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**                  data/response/notification from NFCC
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          TRUE if need to free buffer
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>bool nfc_ncif_process_event(NFC_HDR* p_msg) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t mt, pbf, gid, *p, *pp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    bool free = true;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t oid;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t *p_old, old_gid, old_oid, old_mt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p = (uint8_t*)(p_msg + 1) + p_msg-&gt;offset; // <span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>Buffer<span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    pp = p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    // <span class="ace_cjk" style="width:NaNpx">对</span>Buffer<span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">解</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">赋</span><span class="ace_cjk" style="width:NaNpx">值</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    NCI_MSG_PRS_HDR0(pp, mt, pbf, gid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    oid = ((*pp) &amp; NCI_OID_MASK);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (nfc_cb.rawVsCbflag == true &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    nfc_ncif_proc_proprietary_rsp(mt, gid, oid) == true) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    nci_proc_prop_raw_vs_rsp(p_msg);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    nfc_cb.rawVsCbflag = false;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return free;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    nfcsnoop_capture(p_msg, true);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    switch (mt) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    case NCI_MT_RSP:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    DLOG_IF(INFO, nfc_debug_enabled)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    &lt;&lt; StringPrintf("NFC received rsp gid:%d", gid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    oid = ((*pp) &amp; NCI_OID_MASK);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    p_old = nfc_cb.last_hdr;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    NCI_MSG_PRS_HDR0(p_old, old_mt, pbf, old_gid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    old_oid = ((*p_old) &amp; NCI_OID_MASK);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    /* make sure this is the RSP we are waiting for before updating the
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> * command window */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if ((old_gid != gid) || (old_oid != oid)) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    LOG(ERROR) &lt;&lt; StringPrintf(
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    "nfc_ncif_process_event unexpected rsp: gid:0x%x, oid:0x%x", gid,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    oid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return true;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    switch (gid) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case NCI_GID_CORE: /* 0000b NCI Core group */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    free = nci_proc_core_rsp(p_msg); // &lt;--
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nfc_ncif_update_window();
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return (free);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>使用<code>NCI_MSG_PRS_HDR1</code>获取<code>p[1]</code>位置的数据，赋值为<code>op_code</code>，之后获取一个字节<code>p[2]</code>作为<code>len</code>，当<code>op_code</code>为<code>NCI_MSG_CORE_SET_CONFIG</code>时，调用<code>nfc_ncif_set_config_status()</code>，并且传入Buffer指针，此时Buffer指针指向偏移为<code>3</code>的位置</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/* parse byte1 of NCI Cmd/Ntf */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MSG_PRS_HDR1(p, oid)   \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (oid) = (*(p)&amp;NCI_OID_MASK);   \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (p)++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nci_proc_core_rsp
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      Process NCI responses in the CORE group
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          TRUE-caller of this function to free the GKI buffer p_msg
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>bool nci_proc_core_rsp(NFC_HDR* p_msg) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t* p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t *pp, len, op_code;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    bool free = true;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t* p_old = nfc_cb.last_cmd;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* find the start of the NCI message and parse the NCI header */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p = (uint8_t*)(p_msg + 1) + p_msg-&gt;offset;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    pp = p + 1;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    NCI_MSG_PRS_HDR1(pp, op_code); // op_code = p[1]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    DLOG_IF(INFO, nfc_debug_enabled)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    &lt;&lt; StringPrintf("nci_proc_core_rsp opcode:0x%x", op_code);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    len = *pp++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* process the message based on the opcode and message type */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    switch (op_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    case NCI_MSG_CORE_SET_CONFIG:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nfc_ncif_set_config_status(pp, len); // &lt;--
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return free;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>终于来到了补丁函数，补丁描述是越界读取</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Prevent Out of bounds read/write in nfc_ncif_set_config_status
</div></div></div></pre>
<p>这里可以看到将<code>*p++</code>赋值给<code>evt_data.set_config.status</code>，<code>nfc_cb.p_resp_cback</code>对应的是<code>nfa_dm_nfc_response_cback()</code>，此时可控的变量一共有三个</p>
<ol>
<li>evt_data.set_config.status</li>
<li>evt_data.set_config.num_param_id</li>
<li>evt_data.set_config.param_ids</li>
</ol>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define STREAM_TO_ARRAY(a, p, len)                                   \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>{                                                                    \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    int ijk;                                                         \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    for (ijk = 0; ijk &lt; (len); ijk++) ((uint8_t*)(a))[ijk] = *(p)++; \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nfc_ncif_set_config_status
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      This function is called to report NFC_SET_CONFIG_REVT
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void nfc_ncif_set_config_status(uint8_t* p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    __attribute__((unused)) uint8_t len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tNFC_RESPONSE evt_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (nfc_cb.p_resp_cback) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    evt_data.set_config.status = (tNFC_STATUS)*p++; // p[3]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // #define NFC_STATUS_OK NCI_STATUS_OK
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    // #define NCI_STATUS_OK 0x00
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id = NFC_STATUS_OK; // <span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span><span class="ace_cjk" style="width:NaNpx">为</span>0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (evt_data.set_config.status != NFC_STATUS_OK) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id = *p++; // p[4]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_ARRAY(evt_data.set_config.param_ids, p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id); // <span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">为</span>`p[4]`<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">控</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">拷</span><span class="ace_cjk" style="width:NaNpx">贝</span><span class="ace_cjk" style="width:NaNpx">源</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">控</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    (*nfc_cb.p_resp_cback)(NFC_SET_CONFIG_REVT, &amp;evt_data);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>我们来看<code>evt_data.set_config.param_ids</code>的定义，其中<code>NFC_MAX_NUM_IDS</code>为<code>125</code>，我们知道，<code>uint8_t</code>为无符号类型，大小为<code>255</code>，所以这里足够溢出<code>param_ids</code>数组</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NFC_MAX_NUM_IDS 125
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/* Data for NFA_DM_SET_CONFIG_EVT */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>typedef struct {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tNFA_STATUS status;                   /* NFA_STATUS_OK if successful  */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t num_param_id;                 /* Number of rejected Param ID  */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tNFA_PMID param_ids[NFC_MAX_NUM_IDS]; /* Rejected Param ID            */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>} tNFA_SET_CONFIG;
</div></div></div></pre>
<p>再来回顾补丁</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void nfc_ncif_set_config_status(uint8_t* p, uint8_t len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tNFC_RESPONSE evt_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (nfc_cb.p_resp_cback) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (len == 0) { // <span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span>len<span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">为</span>0<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">为</span>0<span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">面</span><span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">值</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    LOG(ERROR) &lt;&lt; StringPrintf("Insufficient RSP length");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.status = NFC_STATUS_SYNTAX_ERROR;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    (*nfc_cb.p_resp_cback)(NFC_SET_CONFIG_REVT, &amp;evt_data);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    evt_data.set_config.status = (tNFC_STATUS)*p++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    if (evt_data.set_config.status != NFC_STATUS_OK &amp;&amp; len &gt; 1) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id = *p++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">证</span>num_param_id<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">小</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span>NFC_MAX_NUM_IDS
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if (evt_data.set_config.num_param_id &gt; NFC_MAX_NUM_IDS) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    android_errorWriteLog(0x534e4554, "114047681");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    LOG(ERROR) &lt;&lt; StringPrintf("OOB write num_param_id %d",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    } else if (evt_data.set_config.num_param_id &lt;= len - 2) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    // <span class="ace_cjk" style="width:NaNpx">多</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">拷</span><span class="ace_cjk" style="width:NaNpx">贝</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_ARRAY(evt_data.set_config.param_ids, p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    } else {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    LOG(ERROR) &lt;&lt; StringPrintf("Insufficient RSP length %d,num_param_id %d",
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    len, evt_data.set_config.num_param_id);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.set_config.num_param_id = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    (*nfc_cb.p_resp_cback)(NFC_SET_CONFIG_REVT, &amp;evt_data);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
</div></div>
      <script></script>
    </body>
    </html>
  