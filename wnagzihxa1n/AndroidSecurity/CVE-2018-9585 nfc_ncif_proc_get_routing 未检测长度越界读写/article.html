
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-solarized-light .ace_gutter {background: #fbf1d3;color: #333}.ace-solarized-light .ace_print-margin {width: 1px;background: #e8e8e8}.ace-solarized-light {background-color: #FDF6E3;color: #586E75}.ace-solarized-light .ace_cursor {color: #000000}.ace-solarized-light .ace_marker-layer .ace_selection {background: rgba(7, 54, 67, 0.09)}.ace-solarized-light.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #FDF6E3;}.ace-solarized-light .ace_marker-layer .ace_step {background: rgb(255, 255, 0)}.ace-solarized-light .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgba(147, 161, 161, 0.50)}.ace-solarized-light .ace_marker-layer .ace_active-line {background: #EEE8D5}.ace-solarized-light .ace_gutter-active-line {background-color : #EDE5C1}.ace-solarized-light .ace_marker-layer .ace_selected-word {border: 1px solid #073642}.ace-solarized-light .ace_invisible {color: rgba(147, 161, 161, 0.50)}.ace-solarized-light .ace_keyword,.ace-solarized-light .ace_meta,.ace-solarized-light .ace_support.ace_class,.ace-solarized-light .ace_support.ace_type {color: #859900}.ace-solarized-light .ace_constant.ace_character,.ace-solarized-light .ace_constant.ace_other {color: #CB4B16}.ace-solarized-light .ace_constant.ace_language {color: #B58900}.ace-solarized-light .ace_constant.ace_numeric {color: #D33682}.ace-solarized-light .ace_fold {background-color: #268BD2;border-color: #586E75}.ace-solarized-light .ace_entity.ace_name.ace_function,.ace-solarized-light .ace_entity.ace_name.ace_tag,.ace-solarized-light .ace_support.ace_function,.ace-solarized-light .ace_variable,.ace-solarized-light .ace_variable.ace_language {color: #268BD2}.ace-solarized-light .ace_storage {color: #073642}.ace-solarized-light .ace_string {color: #2AA198}.ace-solarized-light .ace_string.ace_regexp {color: #D30102}.ace-solarized-light .ace_comment,.ace-solarized-light .ace_entity.ace_other.ace_attribute-name {color: #93A1A1}.ace-solarized-light .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWNgYGBgYHjy8NJ/AAjgA5fzQUmBAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>CVE-2018-9585 nfc_ncif_proc_get_routing 未检测长度越界读写</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><p>漏洞原理总结：在函数<code>nfc_ncif_proc_get_routing()</code>里，直接获取数据作为长度进行数组拷贝，读取的类型是<code>uint8_t</code>，最大是<code>255</code><br>
，拷贝的数组定义长度<code>125</code>，直接溢出</p>
<p>官方描述：In nfc_ncif_proc_get_routing of nfc_ncif.cc, there is a possible out of bounds write due to a missing bounds check. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.</p>
<p>官方描述翻译：函数<code>nfc_ncif.cc - nfc_ncif_proc_get_routing()</code>里，因为缺少边界检查，存在一个越界写，这可以造成提权并且无需额外的执行权限，利用这个漏洞也不需要用户交互</p>
<table>
<thead>
<tr>
<th>CVE</th>
<th>参考编号</th>
<th>类型</th>
<th>严重程度</th>
<th>已更新的 AOSP 版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE-2018-9585</td>
<td>A-117554809</td>
<td>EoP</td>
<td>高</td>
<td>7.0、7.1.1、7.1.2、8.0、8.1、9</td>
</tr>
</tbody>
</table>
<p>补丁</p>
<ul>
<li><a href="https://android.googlesource.com/platform/system/nfc/+/71764b791f262491e3f628c14ce3949863dd6058">https://android.googlesource.com/platform/system/nfc/+/71764b791f262491e3f628c14ce3949863dd6058</a></li>
</ul>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Prevent OOB error in nfc_ncif_proc_get_routing()
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Test: Tag reading; Card Emulation
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Bug: 117554809
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>Change-Id: Ib49af2eadf870f030a6cddeec390dc498bd5078c
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>(cherry picked from commit ded496ea745656018dda505c23726b4304180c38)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>diff --git a/src/nfc/nfc/nfc_ncif.cc b/src/nfc/nfc/nfc_ncif.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>index 93666e0..6d6607d 100644
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>--- a/src/nfc/nfc/nfc_ncif.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+++ b/src/nfc/nfc/nfc_ncif.cc
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -25,6 +25,7 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  ******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include &lt;android-base/stringprintf.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include &lt;base/logging.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+#include &lt;log/log.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include &lt;metricslogger/metrics_logger.h&gt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> #include "nfc_target.h"
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@@ -1235,8 +1236,13 @@
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>   for (yy = 0; yy &lt; evt_data.num_tlvs; yy++) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> tl = *(p + 1);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> tl += NFC_TL_SIZE;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-        STREAM_TO_ARRAY(pn, p, tl);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> evt_data.tlv_size += tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        if (evt_data.tlv_size &gt; NFC_MAX_EE_TLV_SIZE) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          android_errorWriteLog(0x534e4554, "117554809");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          LOG(ERROR) &lt;&lt; __func__ &lt;&lt; "Invalid data format";
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+          return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        STREAM_TO_ARRAY(pn, p, tl);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> pn += tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>   }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>   tNFC_RESPONSE nfc_response;
</div></div></div></pre>
<p>入口简单的取值判断分支，最后调用到<code>nci_proc_rf_management_ntf()</code></p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MT_MASK 0xE0
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MT_SHIFT 5
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_PBF_MASK 0x10
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_PBF_SHIFT 4
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_GID_MASK 0x0F
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_OID_MASK 0x3F
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/* parse byte0 of NCI packet */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MSG_PRS_HDR0(p, mt, pbf, gid)         \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    mt = (*(p)&amp;NCI_MT_MASK) &gt;&gt; NCI_MT_SHIFT;      \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (pbf) = (*(p)&amp;NCI_PBF_MASK) &gt;&gt; NCI_PBF_SHIFT; \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (gid) = *(p)++ &amp; NCI_GID_MASK;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nfc_ncif_process_event
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      This function is called to process the
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**                  data/response/notification from NFCC
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          TRUE if need to free buffer
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>bool nfc_ncif_process_event(NFC_HDR* p_msg) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t mt, pbf, gid, *p, *pp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    bool free = true;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t oid;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t *p_old, old_gid, old_oid, old_mt;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p = (uint8_t*)(p_msg + 1) + p_msg-&gt;offset;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    pp = p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    NCI_MSG_PRS_HDR0(pp, mt, pbf, gid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    oid = ((*pp) &amp; NCI_OID_MASK); // oid = p[1] &amp; NCI_OID_MASK
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (nfc_cb.rawVsCbflag == true &amp;&amp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    nfc_ncif_proc_proprietary_rsp(mt, gid, oid) == true) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    nci_proc_prop_raw_vs_rsp(p_msg);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    nfc_cb.rawVsCbflag = false;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    return free;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    nfcsnoop_capture(p_msg, true);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    switch (mt) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    case NCI_MT_NTF:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    DLOG_IF(INFO, nfc_debug_enabled)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    &lt;&lt; StringPrintf("NFC received ntf gid:%d", gid);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    switch (gid) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    case NCI_GID_RF_MANAGE: /* 0001b NCI Discovery group */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nci_proc_rf_management_ntf(p_msg);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    return (free);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>获取<code>op_code</code>，当<code>op_code</code>为<code>NCI_MSG_RF_GET_ROUTING</code>时，调用<code>nfc_ncif_proc_get_routing()</code>，传入的缓冲区指针指向<code>p[3]</code>，<code>len</code>字段为<code>p[2]</code>，这俩参数未做判断</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_OID_MASK 0x3F
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/* parse byte1 of NCI Cmd/Ntf */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NCI_MSG_PRS_HDR1(p, oid)   \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (oid) = (*(p)&amp;NCI_OID_MASK);   \
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    (p)++;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nci_proc_rf_management_ntf
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      Process NCI notifications in the RF Management group
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void nci_proc_rf_management_ntf(NFC_HDR* p_msg) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t* p;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t *pp, len, op_code;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    /* find the start of the NCI message and parse the NCI header */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    p = (uint8_t*)(p_msg + 1) + p_msg-&gt;offset; // <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">户</span><span class="ace_cjk" style="width:NaNpx">传</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">的</span>Buffer
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    pp = p + 1; // pp = p[1]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    NCI_MSG_PRS_HDR1(pp, op_code); // op_code = p[1] &amp; NCI_OID_MASK
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    len = *pp++; // len = p[2]<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">完</span><span class="ace_cjk" style="width:NaNpx">后</span>pp<span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span>p[3]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    switch (op_code) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#if (NFC_NFCEE_INCLUDED == TRUE)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#if (NFC_RW_ONLY == FALSE)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    case NCI_MSG_RF_GET_ROUTING:
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nfc_ncif_proc_get_routing(pp, len); // (p[3], p[2])
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    break;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>获取的<code>tl</code>为<code>p[8]</code>，然后将<code>tl</code>加2，<code>tl</code>的类型是<code>uint8_t</code>，最大是<code>255</code>，加上2之后就是<code>257</code>，<code>evt_data.param_tlvs</code>定义的长度为<code>125</code>，所以拷贝数组的时候直接溢出</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>#define NFC_MAX_EE_TLV_SIZE 150
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>typedef struct {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    ...
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t param_tlvs[NFC_MAX_EE_TLV_SIZE]; /* the TLVs         */
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>} tNFC_GET_ROUTING_REVT;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>/*******************************************************************************
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Function         nfc_ncif_proc_get_routing
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Description      This function is called to process get routing notification
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>** Returns          void
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>**
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>*******************************************************************************/
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>void nfc_ncif_proc_get_routing(uint8_t* p,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    __attribute__((unused)) uint8_t len) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tNFC_GET_ROUTING_REVT evt_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    uint8_t more, num_entries, xx, yy, *pn, tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tNFC_STATUS status = NFC_STATUS_CONTINUE;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    if (nfc_cb.p_resp_cback) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    more = *p++; // more = p[3] 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    num_entries = *p++; // num_entries = p[4]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    for (xx = 0; xx &lt; num_entries; xx++) { // <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">多</span><span class="ace_cjk" style="width:NaNpx">个</span>entry
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    if ((more == false) &amp;&amp; (xx == (num_entries - 1))) status = NFC_STATUS_OK;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.status = (tNFC_STATUS)status;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.nfcee_id = *p++; // evt_data.nfcee_id = p[5]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.num_tlvs = *p++; // evt_data.num_tlvs = p[6]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.tlv_size = 0;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    pn = evt_data.param_tlvs; // <span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">组</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">为</span>150
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    for (yy = 0; yy &lt; evt_data.num_tlvs; yy++) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    tl = *(p + 1); // tl = p[8]
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    tl += NFC_TL_SIZE; // #define NFC_TL_SIZE 2
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    STREAM_TO_ARRAY(pn, p, tl); // tl<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">为</span>(255 + 2)<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">但</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">组</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">为</span>150<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">越</span><span class="ace_cjk" style="width:NaNpx">界</span><span class="ace_cjk" style="width:NaNpx">写</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    evt_data.tlv_size += tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    pn += tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    tNFC_RESPONSE nfc_response;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    nfc_response.get_routing = evt_data;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    (*nfc_cb.p_resp_cback)(NFC_GET_ROUTING_REVT, &amp;nfc_response);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></pre>
<p>补丁所做的就是在拷贝前做好<code>evt_data.tlv_size</code>的判断，这个字段表示当前已经拷贝的长度</p>
<pre><div class="ace-solarized-light"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>for (yy = 0; yy &lt; evt_data.num_tlvs; yy++) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tl = *(p + 1);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    tl += NFC_TL_SIZE;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>-   STREAM_TO_ARRAY(pn, p, tl);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    evt_data.tlv_size += tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+   if (evt_data.tlv_size &gt; NFC_MAX_EE_TLV_SIZE) {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        android_errorWriteLog(0x534e4554, "117554809");
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        LOG(ERROR) &lt;&lt; __func__ &lt;&lt; "Invalid data format";
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+        return;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+   }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>+   STREAM_TO_ARRAY(pn, p, tl);
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    pn += tl;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>   tNFC_RESPONSE nfc_response;
</div></div></div></pre>
</div></div>
      <script></script>
    </body>
    </html>
  